<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong Master v6</title>
    <style>
        :root {
            --bg-color: #2d5e3e;
            --table-border: #5c3a21;
            --tile-bg: #fff;
            --tile-color: #000;
            --tile-border: #999;
        }

        body {
            margin: 0;
            background-color: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- MENUS & SCREENS --- */
        .screen {
            position: absolute; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 300;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; }

        h1 { font-size: 4em; color: gold; text-shadow: 0 0 20px orange; margin-bottom: 10px; }
        h2 { color: #ddd; border-bottom: 2px solid gold; padding-bottom: 10px; }

        .menu-btn {
            padding: 15px 40px; margin: 10px;
            font-size: 22px; background: #444;
            color: white; border: 2px solid #666;
            cursor: pointer; transition: all 0.2s;
            width: 320px; text-align: center;
            border-radius: 8px; text-transform: uppercase;
            letter-spacing: 1px;
        }
        .menu-btn:hover { background: gold; color: black; transform: scale(1.05); border-color: white; }

        /* --- STORE GRID --- */
        #store-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 20px; margin: 30px;
        }
        .skin-card {
            border: 2px solid #555; padding: 20px; border-radius: 10px;
            text-align: center; cursor: pointer; background: #222;
            transition: 0.2s;
        }
        .skin-card:hover { background: #333; transform: translateY(-5px); }
        .skin-card.active { border-color: gold; background: #442200; }
        .skin-icon { font-size: 40px; margin-bottom: 10px; display: block; }

        /* --- GAME TABLE --- */
        #game-table {
            position: relative; width: 95vh; height: 95vh;
            max-width: 900px; max-height: 900px;
            border: 15px solid var(--table-border);
            border-radius: 40px; background: var(--bg-color);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
            display: none; /* Hidden until play */
        }

        /* --- HUD (FIXED POSITION) --- */
        #hud-top {
            position: absolute;
            top: 30px; right: 30px; /* Moved to Right to avoid overlapping */
            background: rgba(0,0,0,0.7);
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 18px;
            border: 2px solid rgba(255,215,0,0.3);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 100;
            display: flex; gap: 20px;
        }
        .hud-item { display: flex; align-items: center; gap: 8px; }

        /* --- NOTIFICATIONS --- */
        #center-overlay {
            position: absolute; top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 150;
            text-align: center; width: 100%;
        }
        #big-msg {
            font-size: 6em; font-weight: 900; color: gold;
            text-shadow: 4px 4px 0 #000, 0 0 40px red;
            opacity: 0; transition: all 0.3s;
            transform: scale(0.5);
        }
        #big-msg.show { opacity: 1; transform: scale(1); }

        /* --- ACTION BUTTONS --- */
        #actions {
            position: absolute; top: 60%; left: 50%;
            transform: translate(-50%, -50%);
            display: none; gap: 10px; z-index: 200;
        }
        .action-btn {
            padding: 12px 25px; font-size: 20px; font-weight: bold;
            border: 3px solid rgba(255,255,255,0.5); border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.95); }
        .btn-hu { background: #e74c3c; color: white; animation: pulse 1s infinite; }
        .btn-kong { background: #f1c40f; color: black; }
        .btn-pung { background: #3498db; color: white; }
        .btn-chow { background: #2ecc71; color: black; }
        .btn-skip { background: #95a5a6; color: white; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        /* --- TILES --- */
        .tile {
            width: 40px; height: 54px;
            background: var(--tile-bg); color: var(--tile-color);
            border: 1px solid var(--tile-border); border-radius: 6px;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; box-shadow: 2px 4px 6px rgba(0,0,0,0.4);
            position: relative; user-select: none;
        }
        .tile-back {
            background: #1e824c; border: 1px solid #5fd193;
            color: rgba(255,255,255,0.1);
        }

        /* --- SKINS --- */
        body.skin-dark { --bg-color: #2c3e50; --table-border: #34495e; --tile-bg: #bdc3c7; }
        body.skin-gold { --bg-color: #58140c; --table-border: #f1c40f; --tile-bg: #fffcdb; --tile-color: #5d4037; }

        /* --- PLAYERS --- */
        .hand-container { position: absolute; display: flex; gap: 10px; }
        .exposed-tiles { display: flex; gap: 5px; }
        .hand-tiles { display: flex; gap: 2px; }
        .meld { display: flex; gap: 1px; padding: 0 5px; background: rgba(0,0,0,0.15); border-radius: 4px; }

        /* P0 (User) */
        #p0-area { bottom: 25px; left: 50%; transform: translateX(-50%); align-items: flex-end; }
        #p0-hand .tile { cursor: pointer; transition: transform 0.2s; }
        #p0-hand .tile:hover { transform: translateY(-15px); border-color: gold; z-index: 50; }
        
        /* Bots */
        #p1-area { right: 30px; top: 50%; transform: translateY(-50%); flex-direction: column-reverse; align-items: flex-end; }
        #p1-hand, #p1-exposed { flex-direction: column; }
        #p1-area .tile { transform: rotate(-90deg); width: 54px; height: 40px; }

        #p2-area { top: 25px; left: 50%; transform: translateX(-50%); flex-direction: row-reverse; align-items: flex-start; }
        #p2-area .tile { transform: rotate(180deg); }

        #p3-area { left: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: flex-start; }
        #p3-hand, #p3-exposed { flex-direction: column; }
        #p3-area .tile { transform: rotate(90deg); width: 54px; height: 40px; }

        #discard-pile {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            display: grid; grid-template-columns: repeat(10, 1fr);
            gap: 4px;
        }
    </style>
</head>
<body>

<!-- MAIN MENU -->
<div id="main-menu" class="screen">
    <h1>üÄÑ MAHJONG MASTER</h1>
    <div style="color:gold; margin-bottom:20px; font-size:20px">v6.0 Master Edition</div>
    <div id="menu-coins" style="color:#aaa; margin-bottom:10px">Coins: 100</div>
    
    <button class="menu-btn" onclick="startGame()">‚ñ∂ Start Game</button>
    <button class="menu-btn" onclick="openStore()">üõí Skin Store</button>
    <button class="menu-btn" onclick="openTutorial()">üìñ How to Play</button>
    <button class="menu-btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
</div>

<!-- SHOP SCREEN -->
<div id="store-screen" class="screen hidden">
    <h2>SKIN STORE</h2>
    <div id="store-status" style="color:gold">Coins: 0</div>
    <div id="store-grid"></div>
    <button class="menu-btn" style="width:200px" onclick="showMenu()">Back</button>
</div>

<!-- TUTORIAL SCREEN -->
<div id="tutorial-screen" class="screen hidden">
    <h2>HOW TO PLAY</h2>
    <div style="max-width:600px; text-align:left; line-height:1.6; background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;">
        <p><strong>1. Goal:</strong> Assemble a hand of 4 sets (Triplets or Sequences) and 1 Pair.</p>
        <p><strong>2. Draw & Discard:</strong> Every turn, you draw a tile and must discard one to keep 16 tiles.</p>
        <p><strong>3. PUNG (Á¢∞):</strong> Taking a discarded tile to complete a Triplet (3 identical).</p>
        <p><strong>4. CHOW (ÂêÉ):</strong> Taking a discarded tile from the LEFT player to make a Sequence (e.g. 2-3-4).</p>
        <p><strong>5. KONG (Êù†):</strong> Declaring a Quad (4 identical). You draw a replacement tile.</p>
        <p><strong>6. HU (ËÉ°):</strong> Declaring victory when your hand is complete!</p>
    </div>
    <button class="menu-btn" style="margin-top:20px; width:200px" onclick="showMenu()">Got it!</button>
</div>

<!-- GAME UI -->
<div id="game-table">
    <!-- HUD moved to Top Right to avoid overlapping -->
    <div id="hud-top">
        <div class="hud-item">üÄÑ <span id="wall-count">0</span></div>
        <div class="hud-item">üí∞ <span id="game-coins">0</span></div>
        <button style="background:none; border:1px solid #555; color:#aaa; cursor:pointer; padding:2px 8px; border-radius:4px" onclick="showMenu()">MENU</button>
    </div>

    <div id="center-overlay">
        <div id="big-msg">READY?</div>
    </div>

    <div id="discard-pile"></div>

    <!-- ACTION BAR -->
    <div id="actions">
        <button id="btn-hu" class="action-btn btn-hu" onclick="doWin()">HU! (Win)</button>
        <button id="btn-kong" class="action-btn btn-kong" onclick="doKong()">KONG</button>
        <button id="btn-pung" class="action-btn btn-pung" onclick="doPung()">PUNG</button>
        <button id="btn-chow" class="action-btn btn-chow" onclick="doChow()">CHOW</button>
        <button class="action-btn btn-skip" onclick="skipAction()">PASS</button>
    </div>

    <!-- PLAYER ZONES -->
    <div id="p0-area" class="hand-container">
        <div id="p0-exposed" class="exposed-tiles"></div>
        <div id="p0-hand" class="hand-tiles"></div>
    </div>
    <div id="p1-area" class="hand-container">
        <div id="p1-exposed" class="exposed-tiles"></div>
        <div id="p1-hand" class="hand-tiles"></div>
    </div>
    <div id="p2-area" class="hand-container">
        <div id="p2-exposed" class="exposed-tiles"></div>
        <div id="p2-hand" class="hand-tiles"></div>
    </div>
    <div id="p3-area" class="hand-container">
        <div id="p3-exposed" class="exposed-tiles"></div>
        <div id="p3-hand" class="hand-tiles"></div>
    </div>
</div>

<script>
    /* --- GAME DATA --- */
    const SKINS = {
        'classic': { name: 'Classic Green', cost: 0, class: '' },
        'dark': { name: 'Midnight Blue', cost: 100, class: 'skin-dark' },
        'gold': { name: 'Emperor Gold', cost: 500, class: 'skin-gold' }
    };
    
    // Save System
    let saveData = JSON.parse(localStorage.getItem('mahjongSave')) || { coins: 100, unlocked: ['classic'], activeSkin: 'classic' };
    
    const TILE_MAP = {
        'east': 0x1F000, 'south': 0x1F001, 'west': 0x1F002, 'north': 0x1F003,
        'red': 0x1F004, 'green': 0x1F005, 'white': 0x1F006,
        'chars': 0x1F007, 'bamboo': 0x1F010, 'dots': 0x1F019
    };

    let deck = [], players = [], exposed = [], discardPile = [];
    let turn = 0, lastDiscard = null, isPaused = false;

    /* --- MENU FUNCTIONS --- */
    function showMenu() {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('main-menu').classList.remove('hidden');
        document.getElementById('game-table').style.display = 'none';
        document.getElementById('menu-coins').innerText = `Coins: ${saveData.coins}`;
        applySkin();
    }

    function openStore() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('store-screen').classList.remove('hidden');
        renderStore();
    }

    function openTutorial() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('tutorial-screen').classList.remove('hidden');
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    function renderStore() {
        const grid = document.getElementById('store-grid');
        document.getElementById('store-status').innerText = `Coins: ${saveData.coins}`;
        grid.innerHTML = '';
        
        for (let key in SKINS) {
            const skin = SKINS[key];
            const owned = saveData.unlocked.includes(key);
            const active = saveData.activeSkin === key;
            
            const card = document.createElement('div');
            card.className = `skin-card ${active ? 'active' : ''}`;
            card.innerHTML = `
                <span class="skin-icon">üÄÑ</span>
                <h3>${skin.name}</h3>
                <p>${owned ? (active ? 'SELECTED' : 'OWNED') : skin.cost + ' Coins'}</p>
            `;
            card.onclick = () => buySkin(key);
            grid.appendChild(card);
        }
    }

    function buySkin(key) {
        if (saveData.unlocked.includes(key)) {
            saveData.activeSkin = key;
        } else {
            if (saveData.coins >= SKINS[key].cost) {
                saveData.coins -= SKINS[key].cost;
                saveData.unlocked.push(key);
                saveData.activeSkin = key;
            } else {
                alert("Not enough coins!");
                return;
            }
        }
        localStorage.setItem('mahjongSave', JSON.stringify(saveData));
        applySkin();
        renderStore();
    }

    function applySkin() {
        document.body.className = SKINS[saveData.activeSkin].class;
    }

    /* --- GAME ENGINE --- */
    function startGame() {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('game-table').style.display = 'block';
        document.getElementById('game-coins').innerText = saveData.coins;
        applySkin();
        initRound();
    }

    function initRound() {
        deck = createDeck();
        players = [[], [], [], []];
        exposed = [[], [], [], []];
        discardPile = [];
        turn = 0;
        isPaused = false;
        
        // Deal 13 tiles
        for(let i=0; i<13; i++) for(let p=0; p<4; p++) players[p].push(deck.pop());
        
        players[0].sort(sortAlgo);
        updateUI();
        drawTile(0);
    }

    function createDeck() {
        let d = [];
        ['chars','bamboo','dots'].forEach(t => { for(let i=1; i<=9; i++) for(let k=0; k<4; k++) d.push({type:t, val:i}); });
        ['east','south','west','north','red','green','white'].forEach(v => { for(let k=0; k<4; k++) d.push({type:'honor', val:v}); });
        return d.sort(() => Math.random() - 0.5);
    }

    function drawTile(pid) {
        if(deck.length === 0) return alert("Draw!");
        const t = deck.pop();
        players[pid].push(t);
        updateUI();

        if(pid === 0) {
            // Human Turn
            checkSelfWin();
        } else {
            // Bot Turn
            setTimeout(() => botLogic(pid), 1000);
        }
    }

    function botLogic(pid) {
        // Check Win
        if(checkWin(players[pid])) {
            announce(pid, "HU!", 2000, () => endGame(pid));
            return;
        }
        // Discard
        const idx = Math.floor(Math.random() * players[pid].length);
        discard(pid, idx);
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx, 1)[0];
        lastDiscard = { tile: t, from: pid };
        discardPile.push(t);
        if (pid === 0) players[0].sort(sortAlgo);
        updateUI();
        checkInterrupts(t, pid);
    }

    function checkInterrupts(tile, from) {
        // Human Interrupts
        if (from !== 0) {
            const hand = players[0];
            const canHu = checkWin([...hand, tile]);
            const canKong = hand.filter(x=>isSame(x,tile)).length >= 3;
            const canPung = hand.filter(x=>isSame(x,tile)).length >= 2;
            const canChow = (from === 3) && checkChow(hand, tile);

            if (canHu || canKong || canPung || canChow) {
                isPaused = true;
                showActions(canHu, canKong, canPung, canChow);
                return;
            }
        }

        // Bot Interrupts (Simple RNG)
        let actor = -1, action = "";
        for(let i=1; i<4; i++) {
            if(i !== from) {
                if(checkWin([...players[i], tile])) { actor=i; action="HU!"; break; }
                if(Math.random() < 0.1 && players[i].filter(x=>isSame(x,tile)).length>=2) { actor=i; action="PUNG!"; break; }
            }
        }

        if (actor > -1) {
            isPaused = true;
            announce(actor, action, 2000, () => performBotAction(actor, action, tile));
        } else {
            advanceTurn(from);
        }
    }

    function performBotAction(pid, action, tile) {
        discardPile.pop();
        if(action==="HU!") {
            players[pid].push(tile);
            endGame(pid);
        } else {
            // Pung
            removeFromHand(pid, tile, 2);
            exposed[pid].push([tile, tile, tile]);
            // Bot discards
            setTimeout(() => discard(pid, 0), 1000);
        }
    }

    function advanceTurn(current) {
        drawTile((current + 1) % 4);
    }

    /* --- ACTIONS --- */
    function checkSelfWin() {
        if (checkWin(players[0])) {
             isPaused = true;
             showActions(true, false, false, false);
        }
    }

    window.doWin = function() {
        if(lastDiscard && lastDiscard.from!==0) players[0].push(lastDiscard.tile);
        endGame(0);
    };

    window.doPung = function() {
        const t = lastDiscard.tile; discardPile.pop();
        removeFromHand(0, t, 2);
        exposed[0].push([t,t,t]);
        finishAction();
    };

    window.doKong = function() {
        const t = lastDiscard.tile; discardPile.pop();
        removeFromHand(0, t, 3);
        exposed[0].push([t,t,t,t]);
        drawTile(0); // Replacement
        finishAction(true);
    };

    window.doChow = function() {
        const t = lastDiscard.tile; discardPile.pop();
        const h = players[0];
        // Basic Chow Finder
        const t1 = h.find(x=>x.type===t.type && x.val===t.val-1);
        const t2 = h.find(x=>x.type===t.type && x.val===t.val+1);
        if(t1 && t2) {
            removeSpecific(0, t1); removeSpecific(0, t2);
            exposed[0].push([t1, t, t2].sort(sortAlgo));
            finishAction();
        }
    };

    window.skipAction = function() {
        document.getElementById('actions').style.display = 'none';
        isPaused = false;
        advanceTurn(lastDiscard.from);
    };

    function finishAction(keepTurn) {
        document.getElementById('actions').style.display = 'none';
        updateUI();
        if(!keepTurn) {
            isPaused = false;
            turn = 0; // Human Discard Phase
        }
    }

    function showActions(hu, k, p, c) {
        const b = document.getElementById('actions');
        b.style.display = 'flex';
        document.getElementById('btn-hu').style.display = hu?'block':'none';
        document.getElementById('btn-kong').style.display = k?'block':'none';
        document.getElementById('btn-pung').style.display = p?'block':'none';
        document.getElementById('btn-chow').style.display = c?'block':'none';
    }

    /* --- LOGIC HELPERS --- */
    function checkWin(hand) {
        // Simplified Win Check (1 Pair + Sets)
        let counts = {};
        hand.forEach(t => counts[t.type+t.val] = (counts[t.type+t.val]||0)+1);
        let pairs = 0, sets = 0;
        for(let k in counts) {
            if(counts[k]===2) pairs++;
            if(counts[k]>=3) sets++;
        }
        return pairs === 1 && (sets + pairs >= 5); // Heuristic
    }

    function checkChow(hand, tile) {
        if(tile.type==='honor') return false;
        const has = (v) => hand.some(x => x.type===tile.type && x.val===v);
        return (has(tile.val-1) && has(tile.val+1));
    }

    function announce(pid, msg, time, cb) {
        const el = document.getElementById('big-msg');
        el.innerText = pid===0 ? msg : `BOT ${pid}\n${msg}`;
        el.classList.add('show');
        setTimeout(() => { el.classList.remove('show'); cb(); }, time);
    }

    function endGame(winner) {
        const msg = winner===0 ? "YOU WIN!" : `BOT ${winner} WINS!`;
        document.getElementById('big-msg').innerHTML = `<div style='font-size:0.5em'>GAME OVER</div>${msg}`;
        document.getElementById('big-msg').classList.add('show');
        
        if(winner === 0) {
            saveData.coins += 50;
            localStorage.setItem('mahjongSave', JSON.stringify(saveData));
        }
        setTimeout(() => showMenu(), 3000);
    }

    /* --- UTILS --- */
    function isSame(a,b) { return a.type===b.type && a.val===b.val; }
    function sortAlgo(a,b) { 
        const s = {'chars':100,'dots':200,'bamboo':300,'honor':400};
        const va = typeof a.val==='string' ? 10 : a.val;
        const vb = typeof b.val==='string' ? 10 : b.val;
        return (s[a.type]+va) - (s[b.type]+vb);
    }
    function removeFromHand(pid, t, n) {
        let c = 0;
        players[pid] = players[pid].filter(x => { if(c<n && isSame(x,t)) {c++; return false;} return true; });
    }
    function removeSpecific(pid, t) {
        const i = players[pid].findIndex(x => isSame(x,t));
        if(i>-1) players[pid].splice(i,1);
    }
    function getChar(t) {
        if (t.type === 'honor') return String.fromCodePoint(TILE_MAP[t.val]);
        return String.fromCodePoint(TILE_MAP[t.type] + (t.val - 1));
    }

    /* --- RENDER --- */
    function updateUI() {
        document.getElementById('wall-count').innerText = deck.length;
        const d = document.getElementById('discard-pile');
        d.innerHTML = '';
        discardPile.forEach(t => d.appendChild(createTile(t)));

        [0,1,2,3].forEach(pid => {
            const hDiv = document.getElementById(`p${pid}-hand`);
            const eDiv = document.getElementById(`p${pid}-exposed`);
            hDiv.innerHTML = ''; eDiv.innerHTML = '';

            exposed[pid].forEach(m => {
                const div = document.createElement('div'); div.className='meld';
                m.forEach(t => { let el=createTile(t); el.style.background='#ddd'; div.appendChild(el); });
                eDiv.appendChild(div);
            });

            players[pid].forEach((t, i) => {
                if(pid === 0) {
                    let el = createTile(t);
                    el.onclick = () => { if(!isPaused && turn===0) discard(0, i); };
                    hDiv.appendChild(el);
                } else {
                    let el = document.createElement('div');
                    el.className='tile tile-back';
                    hDiv.appendChild(el);
                }
            });
        });
    }

    function createTile(t) {
        let el = document.createElement('div');
        el.className = `tile ${t.type}`;
        el.innerText = getChar(t);
        return el;
    }

    showMenu();
</script>
</body>
</html>
