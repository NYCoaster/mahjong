<!DOCTYPE html>
<html>
<head>
    <title>ðŸ€„ Taiwanese Mahjong - FIXED</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #2c3e50, #34495e); 
            color: white; 
            text-align: center; 
            padding: 20px;
        }
        .table { 
            background: linear-gradient(#8B4513, #D2691E); 
            border-radius: 20px; 
            padding: 30px; 
            max-width: 1000px; 
            margin: 0 auto; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .hand { 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 15px; 
            display: inline-block; 
            backdrop-filter: blur(10px);
        }
        .tile { 
            display: inline-block; 
            width: 45px; 
            height: 60px; 
            margin: 3px; 
            border-radius: 8px; 
            line-height: 60px; 
            font-size: 14px; 
            font-weight: bold; 
            cursor: pointer; 
            border: 2px solid rgba(0,0,0,0.3);
            transition: all 0.2s;
            position: relative;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.3);
        }
        .tile:hover { transform: scale(1.05); }
        .tile.selected { 
            box-shadow: 0 0 20px gold; 
            transform: scale(1.1); 
        }
        
        /* REAL TILE COLORS */
        .circles { background: linear-gradient(145deg, #FF6B35, #FF8C42); color: white; }
        .bamboos { background: linear-gradient(145deg, #228B22, #32CD32); color: white; }
        .characters { background: linear-gradient(145deg, #8B4513, #D2691E); color: white; }
        .honors { background: linear-gradient(145deg, #4169E1, #1E90FF); color: white; }
        .bonus { background: linear-gradient(145deg, #FF69B4, #FF1493); color: white; }
        .discard { background: #ff4444 !important; transform: rotate(5deg); }
        
        button { 
            padding: 12px 24px; 
            font-size: 16px; 
            margin: 10px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            background: linear-gradient(#4CAF50, #45a049); 
            color: white; 
        }
        button:hover { transform: translateY(-2px); }
        
        #log { 
            height: 250px; 
            overflow-y: scroll; 
            background: rgba(0,0,0,0.5); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 20px auto; 
            max-width: 1000px; 
            text-align: left;
        }
        .current { border: 3px solid gold !important; }
    </style>
</head>
<body>
    <div class="table">
        <h1>ðŸ€„ Taiwanese Mahjong vs Robots</h1>
        <div id="status">Click NEW GAME to start</div>
        
        <div id="hands"></div>
        
        <button onclick="newGame()">New Game</button>
        <button onclick="autoPlay()">Auto Turn</button>
        <button onclick="showAll()">Show All Hands</button>
        
        <div id="log"></div>
    </div>

    <script>
        // GAME STATE
        const game = {
            players: [],
            wall: [],
            currentPlayer: 0,
            selectedTile: null,
            gameOver: false
        };

        // TILE DEFINITIONS
        const SUITS = ['c', 'b', 'ch'];
        const HONORS = ['e','s','w','n','rd','gd','wd'];
        const BONUS = ['f1','f2','f3','f4','s1','s2','s3','s4'];

        // CREATE DECK (144 tiles)
        function createDeck() {
            let deck = [];
            // Suits: 1-9 x4 each suit
            for(let suit of SUITS) {
                for(let n=1; n<=9; n++) {
                    for(let i=0; i<4; i++) {
                        deck.push(`${n}${suit}`);
                    }
                }
            }
            // Honors x4 each
            for(let h of HONORS) {
                for(let i=0; i<4; i++) {
                    deck.push(h);
                }
            }
            // Bonus x1 each
            deck.push(...BONUS);
            return deck;
        }

        // PLAYER CLASS
        class Player {
            constructor(name, isRobot) {
                this.name = name;
                this.isRobot = isRobot;
                this.hand = [];
                this.bonus = [];
                this.discards = [];
            }
            
            sortHand() {
                this.hand.sort((a,b) => a.localeCompare(b));
            }
        }

        // NEW GAME
        function newGame() {
            // Create and shuffle deck
            let deck = createDeck();
            for(let i = deck.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            game.wall = deck.slice(0, 120); // Simplified wall
            game.players = [
                new Player('You', false),
                new Player('Robot 1', true),
                new Player('Robot 2', true),
                new Player('Robot 3', true)
            ];
            
            // Deal 16 tiles each
            game.players.forEach(player => {
                player.hand = [];
                player.bonus = [];
                player.discards = [];
                
                for(let i = 0; i < 16; i++) {
                    if(game.wall.length === 0) break;
                    let tile = game.wall.shift();
                    if(BONUS.includes(tile)) {
                        player.bonus.push(tile);
                        if(game.wall.length) tile = game.wall.shift();
                    }
                    player.hand.push(tile);
                }
                player.sortHand();
            });
            
            game.currentPlayer = 0;
            game.selectedTile = null;
            game.gameOver = false;
            
            updateDisplay();
            document.getElementById('status').innerHTML = 'Your turn - Click a tile twice to discard';
            log('ðŸŽ® New game started!');
        }

        // DISPLAY UPDATE
        function updateDisplay(showAll = false) {
            let html = '';
            game.players.forEach((player, i) => {
                let style = (i === 0 || showAll) ? '' : 'display:none;';
                let tileClass = i === game.currentPlayer ? 'current' : '';
                
                let handHtml = player.hand.map(tile => 
                    `<div class="tile ${getTileClass(tile)} ${game.selectedTile === tile && i === 0 ? 'selected' : ''}" 
                       onclick="selectTile('${tile}', ${i})">${getTileText(tile)}</div>`
                ).join('');
                
                html += `
                    <div class="hand ${tileClass}" style="${style}">
                        <h3>${player.name} (${player.hand.length} tiles, ${player.bonus.length} bonus)</h3>
                        <div>${handHtml}</div>
                        <small>Discards: ${player.discards.slice(-5).map(getTileText).join(' ')}</small>
                    </div>
                `;
            });
            document.getElementById('hands').innerHTML = html;
        }

        // TILE CLASS AND TEXT
        function getTileClass(tile) {
            if(BONUS.includes(tile)) return 'bonus';
            if(HONORS.includes(tile)) return 'honors';
            let suit = tile.slice(-1);
            return suit === 'c' ? 'circles' : suit === 'b' ? 'bamboos' : 'characters';
        }

        function getTileText(tile) {
            if(BONUS.includes(tile)) return 'ðŸŒ¸';
            if(HONORS.includes(tile)) return tile.toUpperCase();
            return tile.slice(0, -1);
        }

        // TILE SELECTION
        function selectTile(tile, playerIdx) {
            if(game.gameOver || playerIdx !== 0 || game.currentPlayer !== 0) return;
            
            if(game.selectedTile === tile) {
                // DISCARD
                game.players[0].hand = game.players[0].hand.filter(t => t !== tile);
                game.players[0].discards.push(tile);
                game.selectedTile = null;
                
                log(`You discarded ${getTileText(tile)}`);
                setTimeout(nextTurn, 500);
            } else {
                game.selectedTile = tile;
                updateDisplay();
                log(`Selected: ${getTileText(tile)} (click again to discard)`);
            }
        }

        // ROBOT TURN
        function robotTurn() {
            let player = game.players[game.currentPlayer];
            // Simple AI: discard random tile
            let discard = player.hand.splice(Math.floor(Math.random() * player.hand.length), 1)[0];
            player.discards.push(discard);
            
            log(`${player.name} discards ${getTileText(discard)}`);
        }

        // NEXT TURN
        function nextTurn() {
            game.currentPlayer = (game.currentPlayer + 1) % 4;
            updateDisplay();
            
            if(game.players[game.currentPlayer].isRobot) {
                setTimeout(() => {
                    robotTurn();
                    setTimeout(nextTurn, 800);
                }, 300);
            } else {
                document.getElementById('status').innerHTML = 'Your turn - Click a tile twice to discard';
                log('Your turn!');
            }
        }

        // UTILITY FUNCTIONS
        function autoPlay() {
            if(game.currentPlayer === 0 && game.selectedTile === null) {
                let tile = game.players[0].hand[Math.floor(Math.random() * game.players[0].hand.length)];
                selectTile(tile, 0);
            }
        }

        function showAll() {
            updateDisplay(true);
            log('Showing all hands');
        }

        function log(msg) {
            let logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div>${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // START GAME
        newGame();
    </script>
</body>
</html>
