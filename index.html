<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong: Universal Edition</title>
    <style>
        :root {
            /* --- FLUENT PALETTE --- */
            --mica: #f3f3f3;
            --surface: #ffffff;
            --accent: #0078d4;
            --text: #202020;
            --border: #e0e0e0;
            
            /* --- TILE PALETTE --- */
            --t-bg: #fff;
            --t-dot: #2d5af5;
            --t-bam: #107c10;
            --t-wan: #d13438;
            --t-wind: #202020;
        }

        body.dark {
            --mica: #202020; --surface: #2b2b2b; --text: #fff; --border: #404040;
            --t-bg: #3a3a3a; --t-dot: #4cc2ff; --t-bam: #6ccb5f; --t-wan: #ff99a4; --t-wind: #fff;
        }

        body {
            margin: 0; background: var(--mica); color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; user-select: none;
        }

        /* --- APP SHELL --- */
        #titlebar {
            height: 40px; background: var(--surface); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; font-size: 12px; font-weight: 600;
        }

        #layout {
            display: flex; flex: 1; height: calc(100% - 40px);
        }

        #sidebar {
            width: 240px; background: var(--surface); border-right: 1px solid var(--border);
            padding: 16px; display: flex; flex-direction: column; gap: 8px;
        }

        .nav-btn {
            padding: 10px 12px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; gap: 10px; font-size: 14px;
            transition: 0.1s;
        }
        .nav-btn:hover { background: rgba(0,0,0,0.05); }
        .nav-btn.active { background: rgba(0,120,212,0.1); color: var(--accent); font-weight: 600; }
        
        /* --- MAIN VIEW --- */
        #viewport {
            flex: 1; position: relative; background: #2d5e3e;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }
        body.dark #viewport { background: #1a1a1a; }

        /* --- TILE RENDERER (CSS GRAPHICS) --- */
        .tile {
            width: 42px; height: 60px;
            background: var(--t-bg);
            border: 1px solid #ccc; border-radius: 6px;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.3);
            position: relative; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .tile:hover { transform: translateY(-5px); border-color: var(--accent); }
        
        .t-corner {
            position: absolute; top: 2px; left: 4px;
            font-size: 10px; font-weight: bold; opacity: 0.6;
        }
        .t-main { font-size: 24px; font-weight: bold; line-height: 1; }
        
        /* Suit Colors */
        .type-dots { color: var(--t-dot); }
        .type-bamboo { color: var(--t-bam); }
        .type-chars { color: var(--t-wan); }
        .type-honor { color: var(--t-wind); }
        .type-red { color: #d13438; } .type-green { color: #107c10; }

        .tile-back {
            background: #2b5797; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
        }
        .tile-back::after { content: ''; width: 20px; height: 30px; border: 2px solid rgba(255,255,255,0.2); border-radius: 4px; }

        /* --- GAME LAYOUT --- */
        #game-table {
            position: relative; width: 800px; height: 800px;
        }

        .hand { position: absolute; display: flex; gap: 4px; }
        .exposed { display: flex; gap: 2px; margin-right: 8px; opacity: 0.9; }
        .meld { background: rgba(0,0,0,0.2); padding: 4px; border-radius: 4px; display: flex; gap: 1px; }

        /* Player 0 (Human) */
        #p0-area { bottom: 30px; left: 50%; transform: translateX(-50%); align-items: flex-end; }
        /* Bots */
        #p1-area { right: 20px; top: 50%; transform: translateY(-50%) rotate(-90deg); flex-direction: row-reverse; }
        #p2-area { top: 20px; left: 50%; transform: translateX(-50%) rotate(180deg); flex-direction: row-reverse; }
        #p3-area { left: 20px; top: 50%; transform: translateY(-50%) rotate(90deg); flex-direction: row-reverse; }

        #discard-pile {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px;
        }

        /* --- OVERLAYS --- */
        #action-bar {
            position: absolute; top: 65%; left: 50%; transform: translateX(-50%);
            display: none; gap: 10px; z-index: 100;
        }
        .btn-action {
            padding: 10px 20px; border-radius: 20px; border: none;
            font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background: var(--surface); color: var(--text);
        }
        .btn-action:hover { transform: scale(1.05); }
        .btn-win { background: #e81123; color: white; }

        #big-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: var(--surface); padding: 30px 50px; border-radius: 8px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; z-index: 200;
        }
        
        /* PAGES */
        .page { display: none; padding: 40px; background: var(--surface); position: absolute; inset: 0; z-index: 50; overflow-y: auto; }
        .page.active { display: block; }
        
        /* SHOP */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { border: 1px solid var(--border); padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; }
        .card:hover { border-color: var(--accent); background: rgba(0,120,212,0.05); }
        .card.active { border: 2px solid var(--accent); }

    </style>
</head>
<body>

    <div id="titlebar">
        <span>ðŸ€„ Mahjong Fluent</span>
        <div style="display:flex; gap:10px">
            <span id="coin-display" style="color:#e8a317">ðŸ’° 100</span>
        </div>
    </div>

    <div id="layout">
        <div id="sidebar">
            <div class="nav-btn active" onclick="nav('game')">â–¶ Play</div>
            <div class="nav-btn" onclick="nav('shop')">ðŸ›’ Shop</div>
            <div class="nav-btn" onclick="nav('settings')">âš™ Settings</div>
        </div>

        <div id="viewport">
            
            <!-- GAME PAGE -->
            <div id="game-view" style="display:block">
                <div id="game-table">
                    <div id="discard-pile"></div>
                    
                    <!-- Action Buttons -->
                    <div id="action-bar">
                        <button class="btn-action btn-win" onclick="act('hu')">WIN!</button>
                        <button class="btn-action" onclick="act('kong')">Kong</button>
                        <button class="btn-action" onclick="act('pung')">Pung</button>
                        <button class="btn-action" onclick="act('chow')">Chow</button>
                        <button class="btn-action" onclick="act('skip')">Pass</button>
                    </div>

                    <!-- Notification -->
                    <div id="big-msg">
                        <h1 id="msg-txt">VICTORY</h1>
                        <button class="btn-action" onclick="startGame()">Play Again</button>
                    </div>

                    <!-- Players -->
                    <div id="p0-area" class="hand"><div class="exposed"></div><div class="h-tiles hand"></div></div>
                    <div id="p1-area" class="hand"><div class="exposed"></div><div class="h-tiles hand"></div></div>
                    <div id="p2-area" class="hand"><div class="exposed"></div><div class="h-tiles hand"></div></div>
                    <div id="p3-area" class="hand"><div class="exposed"></div><div class="h-tiles hand"></div></div>
                </div>
            </div>

            <!-- SHOP PAGE -->
            <div id="page-shop" class="page">
                <h1>Skin Shop</h1>
                <p>Use your coins to buy table themes.</p>
                <div id="shop-grid" class="grid"></div>
            </div>

            <!-- SETTINGS PAGE -->
            <div id="page-settings" class="page">
                <h1>Settings</h1>
                <button class="btn-action" onclick="resetData()">Reset Data</button>
                <br><br>
                <button class="btn-action" onclick="document.body.classList.toggle('dark')">Toggle Dark Mode</button>
            </div>

        </div>
    </div>

<script>
    /* --- APP STATE --- */
    const App = {
        data: JSON.parse(localStorage.getItem('fluentMahjong')) || { coins: 100, skins: ['classic'], active: 'classic' },
        save() { localStorage.setItem('fluentMahjong', JSON.stringify(this.data)); updateUI(); }
    };

    /* --- VISUAL TILE GENERATOR (NO UNICODE) --- */
    function createTile(t) {
        const el = document.createElement('div');
        el.className = `tile type-${t.type}`;
        
        // Corner Label
        const label = document.createElement('div');
        label.className = 't-corner';
        
        // Main Graphic
        const main = document.createElement('div');
        main.className = 't-main';

        if (t.type === 'dots') {
            label.innerText = t.val;
            main.innerText = 'â—'.repeat(t.val > 4 ? 1 : t.val); // Simplified representation
            if(t.val > 4) main.innerText = t.val + 'â—';
        } else if (t.type === 'bamboo') {
            label.innerText = t.val;
            main.innerText = 'â•‘';
            if(t.val == 1) main.innerText = 'ðŸ¦';
        } else if (t.type === 'chars') {
            label.innerText = t.val;
            main.innerText = t.val;
        } else if (t.type === 'honor') {
            const map = {'east':'E','south':'S','west':'W','north':'N','red':'R','green':'G','white':'â–¡'};
            label.innerText = map[t.val];
            main.innerText = map[t.val];
            if(t.val==='red') el.classList.add('type-red');
            if(t.val==='green') el.classList.add('type-green');
        }

        el.appendChild(label);
        el.appendChild(main);
        return el;
    }

    /* --- GAME LOGIC --- */
    let deck=[], players=[], exposed=[], discardPile=[], turn=0, lastDiscard=null, paused=false;

    function startGame() {
        document.getElementById('big-msg').style.display='none';
        document.getElementById('action-bar').style.display='none';
        
        deck = [];
        ['dots','bamboo','chars'].forEach(t=>{ for(let i=1;i<=9;i++) for(let k=0;k<4;k++) deck.push({type:t, val:i}); });
        ['east','south','west','north','red','green','white'].forEach(v=>{ for(let k=0;k<4;k++) deck.push({type:'honor', val:v}); });
        deck.sort(()=>Math.random()-0.5);

        players=[[],[],[],[]]; exposed=[[],[],[],[]]; discardPile=[];
        for(let i=0;i<13;i++) for(let p=0;p<4;p++) players[p].push(deck.pop());
        
        players[0].sort(sortTiles);
        render();
        setTimeout(()=>draw(0), 500);
    }

    function draw(pid) {
        if(deck.length===0) return end(-1);
        const t = deck.pop();
        players[pid].push(t);
        render();
        
        if(pid===0) {
            if(checkWin(players[0])) showActs(true,false,false,false);
        } else {
            setTimeout(()=>botPlay(pid), 1000);
        }
    }

    function botPlay(pid) {
        if(checkWin(players[pid])) return end(pid);
        discard(pid, Math.floor(Math.random()*players[pid].length));
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx,1)[0];
        lastDiscard = {t, from:pid};
        discardPile.push(t);
        if(pid===0) players[0].sort(sortTiles);
        render();
        checkInt(t, pid);
    }

    function checkInt(t, from) {
        if(from!==0) {
            const h = players[0];
            const win = checkWin([...h,t]);
            const pung = h.filter(x=>same(x,t)).length>=2;
            const kong = h.filter(x=>same(x,t)).length>=3;
            if(win||pung||kong) { paused=true; showActs(win,kong,pung,false); return; }
        }
        turn = (from+1)%4;
        setTimeout(()=>draw(turn), 500);
    }

    window.act = function(type) {
        document.getElementById('action-bar').style.display='none';
        const t = lastDiscard.t;
        if(type==='skip') { turn=(lastDiscard.from+1)%4; draw(turn); return; }
        if(type==='hu') { end(0); return; }
        
        discardPile.pop();
        let rem = type==='kong'?3:2;
        let c=0; players[0]=players[0].filter(x=>{if(c<rem&&same(x,t)){c++;return false}return true});
        let meld = Array(rem+1).fill(t);
        exposed[0].push(meld);
        
        if(type==='kong') draw(0);
        else { render(); turn=0; } // User turn to discard
    };

    function render() {
        const d = document.getElementById('discard-pile');
        d.innerHTML=''; discardPile.forEach(t=>d.appendChild(createTile(t)));

        [0,1,2,3].forEach(pid => {
            const area = document.getElementById(`p${pid}-area`);
            const expDiv = area.querySelector('.exposed');
            const handDiv = area.querySelector('.h-tiles');
            expDiv.innerHTML=''; handDiv.innerHTML='';

            exposed[pid].forEach(m => {
                const div = document.createElement('div'); div.className='meld';
                m.forEach(t=>div.appendChild(createTile(t)));
                expDiv.appendChild(div);
            });

            players[pid].forEach((t,i) => {
                if(pid===0) {
                    const el = createTile(t);
                    el.onclick = () => { if(!paused && turn===0) discard(0,i); };
                    handDiv.appendChild(el);
                } else {
                    const el = document.createElement('div'); el.className='tile tile-back';
                    handDiv.appendChild(el);
                }
            });
        });
    }

    /* --- UTILS --- */
    function sortTiles(a,b){ const o={'dots':0,'bamboo':1,'chars':2,'honor':3}; return (o[a.type]*10+getV(a)) - (o[b.type]*10+getV(b)); }
    function getV(t){ return typeof t.val==='number'?t.val:10; }
    function same(a,b){ return a.type===b.type && a.val===b.val; }
    function checkWin(h){ 
        let m={}; h.forEach(x=>m[x.type+x.val]=(m[x.type+x.val]||0)+1);
        let p=0; for(let k in m) if(m[k]===2) p++;
        return p===1 && h.length%3===2;
    }
    function end(w) {
        const msg = document.getElementById('big-msg');
        document.getElementById('msg-txt').innerText = w===0 ? "VICTORY! (+100 Coins)" : "DEFEAT";
        msg.style.display='block';
        if(w===0) { App.data.coins+=100; App.save(); }
    }
    function showActs(w,k,p,c) {
        const b = document.getElementById('action-bar'); b.style.display='flex';
        const btns = b.children;
        btns[0].style.display=w?'block':'none'; btns[1].style.display=k?'block':'none';
        btns[2].style.display=p?'block':'none'; btns[3].style.display=c?'block':'none';
    }

    /* --- NAV --- */
    function nav(id) {
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
        if(id==='shop') loadShop();
        if(id!=='game') document.getElementById(`page-${id}`).classList.add('active');
        else document.getElementById('game-view').style.display='block';
    }
    
    function loadShop() {
        const g = document.getElementById('shop-grid'); g.innerHTML='';
        ['Classic', 'Neon', 'Gold'].forEach(n => {
            const el = document.createElement('div'); el.className='card';
            el.innerHTML = `<h3>${n}</h3><p>200 Coins</p>`;
            el.onclick = () => { 
                if(App.data.coins >= 200) { App.data.coins-=200; App.save(); alert('Bought!'); }
                else alert('Not enough coins');
            };
            g.appendChild(el);
        });
    }

    function updateUI() { document.getElementById('coin-display').innerText = 'ðŸ’° ' + App.data.coins; }
    function resetData() { localStorage.clear(); location.reload(); }

    startGame();
    updateUI();
</script>
</body>
</html>
