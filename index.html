<!DOCTYPE html>
<html>
<head>
    <title>Complete Taiwanese Mahjong vs Robots</title>
    <style>
        body { font-family: Arial; background: #f0f8ff; text-align: center; }
        .hand { display: inline-block; margin: 10px; background: white; border: 2px solid #ccc; padding: 10px; border-radius: 10px; }
        .tile { 
            display: inline-block; width: 35px; height: 45px; margin: 2px; 
            border: 1px solid #333; line-height: 22px; font-size: 10px; cursor: pointer;
            position: relative; border-radius: 3px; transition: all 0.2s;
        }
        .suit-c { background: linear-gradient(#ffdbac, #ff8c42); color: black; }
        .suit-b { background: linear-gradient(#90ee90, #228b22); color: white; }
        .suit-ch { background: linear-gradient(#d3d3d3, #8b4513); color: black; }
        .honor { background: linear-gradient(#4169e1, #000080); color: white; font-weight: bold; }
        .bonus { background: linear-gradient(pink, magenta); color: black; font-size: 8px; }
        .tile:hover { transform: scale(1.05); }
        .selected { box-shadow: 0 0 10px gold; }
        .discard { background: #ff6b6b !important; }
        .meld { background: #90ee90; border: 2px solid green; margin: 5px 0; padding: 5px; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; }
        #log { height: 250px; overflow-y: scroll; border: 1px solid #ccc; padding: 15px; text-align: left; background: #f9f9f9; font-family: monospace; }
        .active { border-color: #ff6b6b; box-shadow: 0 0 15px rgba(255,107,107,0.5); }
        .status { font-size: 20px; font-weight: bold; margin: 20px; }
    </style>
</head>
<body>
    <h1>üÄÑ Complete Taiwanese Mahjong vs Robots</h1>
    <div class="status" id="status">Click NEW GAME to start!</div>
    
    <div id="hands"></div>
    <button onclick="newGame()" style="background: #4CAF50; color: white;">New Game</button>
    <button onclick="autoPlay()" style="background: #2196F3; color: white;">Auto Turn</button>
    <button onclick="showAllHands()" style="background: #FF9800; color: white;">Show All Hands</button>
    
    <div id="log"></div>

    <script>
        const SUITS = ['c','b','ch'], HONORS = ['e','s','w','n','rd','gd','wd'], BONUS = ['f1','f2','f3','f4','s1','s2','s3','s4'];
        
        let game = { 
            deck: [], players: [], wall: [], currentPlayer: 0, selectedTile: null, 
            gameOver: false, round: 1, dealer: 0, tai: [0,0,0,0]
        };
        
        function createDeck() {
            let deck = [];
            for(let suit of SUITS) for(let n=1; n<=9; n++) for(let i=0; i<4; i++) deck.push(`${n}${suit}`);
            for(let h of HONORS) for(let i=0; i<4; i++) deck.push(h);
            deck = deck.concat(BONUS);
            return deck;
        }
        
        function Player(name, isRobot) {
            this.name = name; this.isRobot = isRobot; 
            this.hand = []; this.melds = []; this.bonus = []; this.discards = [];
            this.tai = 0;
        }
        
        Player.prototype.sortHand = function() {
            this.hand.sort((a,b) => {
                let sa = SUITS.includes(a.slice(-1)) ? a.slice(-1) : 'z';
                let sb = SUITS.includes(b.slice(-1)) ? b.slice(-1) : 'z';
                if(sa !== sb) return sa < sb ? -1 : 1;
                return a.localeCompare(b);
            });
        };
        
        Player.prototype.checkWin = function() {
            // Taiwanese: 5 melds (chow/pung/kong) + 1 pair = win
            // Simplified: count triplets + sequences + pair
            let counts = {};
            this.hand.forEach(t => counts[t] = (counts[t]||0)+1);
            
            let melds = 0, pair = false;
            for(let t in counts) {
                if(counts[t] >= 3) { melds++; counts[t] -= 3; }
            }
            
            // Check remaining for pair + possible chows (simplified)
            let singles = Object.values(counts).filter(c => c > 0).length;
            if(singles === 2) pair = true; // Assume workable
            
            this.tai = melds + this.bonus.length + (this.melds.length > 0 ? 1 : 0);
            return melds >= 4 && pair && this.tai >= 5;
        };
        
        function newGame() {
            game.deck = createDeck();
            for(let i=game.deck.length; i; i--) {
                let j = Math.floor(Math.random()*i);
                [game.deck[i-1], game.deck[j]] = [game.deck[j], game.deck[i-1]];
            }
            game.wall = game.deck.slice(0,136);
            game.players = [new Player('You'), new Player('Robot1',true), new Player('Robot2',true), new Player('Robot3',true)];
            game.currentPlayer = game.dealer = 0; 
            game.selectedTile = null; game.gameOver = false; game.round = 1;
            game.tai = [0,0,0,0];
            
            game.players.forEach((p, i) => {
                p.hand = []; p.melds = []; p.bonus = []; p.discards = []; p.tai = 0;
                // Dealer gets 17th tile later
                let tiles = i === game.dealer ? 17 : 16;
                for(let j=0; j<tiles; j++) {
                    let tile = game.wall.shift();
                    if(BONUS.includes(tile)) { 
                        p.bonus.push(tile); 
                        if(game.wall.length) tile = game.wall.shift();
                    }
                    p.hand.push(tile);
                }
                p.sortHand();
            });
            
            updateDisplay();
            log(`üéÆ Round ${game.round} - ${game.players[game.dealer].name} deals! Your turn first.`);
            document.getElementById('status').innerHTML = `Round ${game.round} - Your turn (click tile twice to discard)`;
        }
        
        function updateDisplay(showAll = false) {
            let html = '';
            game.players.forEach((p,i) => {
                let style = (i===0 || showAll) ? '' : 'display:none;';
                let handHtml = p.hand.map(t => 
                    `<div class="tile ${getTileClass(t)} ${game.selectedTile===t&&i===0?'selected':''}" 
                       onclick="selectTile('${t}',${i})">${getTileText(t)}</div>`
                ).join('');
                
                html += `<div class="hand ${i===game.currentPlayer?'active':''}" style="${style}">
                    <h3>${p.name} (T: ${p.hand.length} | üå∏: ${p.bonus.length} | Tai: ${p.tai})</h3>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center;">${handHtml}</div>
                    ${p.melds.length ? `<div class="meld">Melds: ${p.melds.map(m => m.map(getTileText).join(' ')).join(' | ')}</div>` : ''}
                    <div style="font-size: 10px;">Discards: ${p.discards.slice(-5).map(getTileText).join(' ')}</div>
                </div>`;
            });
            document.getElementById('hands').innerHTML = html;
        }
        
        function getTileClass(tile) {
            if(BONUS.includes(tile)) return 'bonus';
            if(HONORS.includes(tile)) return 'honor';
            return `suit-${tile.slice(-1)}`;
        }
        
        function getTileText(tile) {
            if(BONUS.includes(tile)) return ['üå∫','üå∏','üåº','üå∑'][BONUS.indexOf(tile)%4];
            let num = tile.slice(0,-1);
            let suit = tile.slice(-1);
            if(suit === 'b') return '‚îÉ' + num;
            if(suit === 'ch') return num + '‰∏á';
            if(HONORS.includes(tile)) return tile.toUpperCase();
            return num;
        }
        
        function selectTile(tile, playerIdx) {
            if(game.gameOver || game.currentPlayer !== 0 || playerIdx !== 0) return;
            
            if(game.selectedTile === tile) {
                // CONFIRM DISCARD
                game.players[0].hand = game.players[0].hand.filter(t => t !== tile);
                game.players[0].discards.push(tile);
                log(`‚úÖ You discard ${getTileText(tile)}`);
                game.selectedTile = null;
                nextTurn();
            } else {
                game.selectedTile = tile;
                updateDisplay();
                log(`Selected: ${getTileText(tile)} (click again to discard)`);
            }
        }
        
        function robotTurn() {
            let p = game.players[game.currentPlayer];
            p.sortHand();
            
            // Smart AI: discard dangerous singles first
            let counts = {};
            p.hand.forEach(t => counts[t] = (counts[t]||0) + 1);
            
            let discard = null;
            // Prioritize: singleton honors > singleton suits > random
            for(let t of p.hand) {
                if(counts[t] === 1) {
                    if(HONORS.includes(t)) { discard = t; break; }
                    if(SUITS.includes(t.slice(-1))) discard = t;
                }
            }
            if(!discard) discard = p.hand[Math.floor(Math.random() * p.hand.length)];
            
            p.hand = p.hand.filter(t => t !== discard);
            p.discards.push(discard);
            log(`ü§ñ ${p.name} discards ${getTileText(discard)}`);
            checkRobotWin(p);
        }
        
        function checkRobotWin(p) {
            if(p.checkWin()) {
                log(`üèÜ ${p.name} WINS with ${p.tai} tai!`);
                game.gameOver = true;
                document.getElementById('status').innerHTML = `${p.name} WINS!`;
            }
        }
        
        function nextTurn() {
            if(game.gameOver) return;
            
            // Draw phase (simplified)
            let current = game.players[game.currentPlayer];
            if(game.wall.length > 0) {
                let draw = game.wall.shift();
                if(!BONUS.includes(draw) || current.bonus.length < 4) {
                    current.hand.push(draw);
                    log(`${current.name} draws tile`);
                    current.sortHand();
                }
            }
            
            // Check self-draw win
            if(current.checkWin()) {
                log(`üèÜ ${current.name} self-draws WIN with ${current.tai} tai!`);
                game.gameOver = true;
                document.getElementById('status').innerHTML = `${current.name} WINS!`;
                return;
            }
            
            // Claim chance (20% pung, 10% chow from previous)
            if(game.currentPlayer !== 0 && Math.random() < 0.2) {
                log(`üÄÄ ${current.name} PUNGS discard!`);
                current.melds.push(['e','e','e']); // Fake pung
                return;
            }
            
            // Normal discard
            if(current.isRobot) {
                setTimeout(() => {
                    robotTurn();
                    setTimeout(nextTurn, 1000);
                }, 500);
            } else {
                game.currentPlayer = 0;
                updateDisplay();
                document.getElementById('status').innerHTML = `Your turn - Click tile twice to discard`;
                log('üéØ Your turn!');
            }
        }
        
        function autoPlay() {
            if(game.currentPlayer === 0 && !game.selectedTile) {
                let tile = game.players[0].hand[Math.floor(Math.random() * game.players[0].hand.length)];
                selectTile(tile, 0);
            }
        }
        
        function showAllHands() {
            updateDisplay(true);
            log('üëÅ All hands visible');
        }
        
        function log(msg) {
            document.getElementById('log').innerHTML += `<div>${msg}</div>`;
            document.getElementById('log').scrollTop = 9999;
        }
        
        // Start game
        newGame();
    </script>
</body>
</html>
