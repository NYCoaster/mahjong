<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong: Windows Edition</title>
    <style>
        :root {
            /* Microsoft Fluent Palette */
            --mica-bg: #f3f3f3;
            --window-bg: #ffffff;
            --accent: #0078d4;
            --accent-hover: #006cc1;
            --text-primary: #202020;
            --text-secondary: #606060;
            --border: #e5e5e5;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --font: 'Segoe UI', 'Segoe UI Variable', sans-serif;
            
            /* Game Specific */
            --table-felt: #2d5e3e;
            --tile-face: #ffffff;
            --tile-back: #2b5797; /* Windows Blue */
        }

        /* DARK MODE */
        body.theme-dark {
            --mica-bg: #202020;
            --window-bg: #2c2c2c;
            --accent: #4cc2ff;
            --accent-hover: #4cc2ff;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border: #454545;
            --shadow: 0 8px 24px rgba(0,0,0,0.4);
            --table-felt: #1e1e1e;
            --tile-face: #e0e0e0;
            --tile-back: #3a3a3a;
        }

        /* HIGH CONTRAST */
        body.theme-contrast {
            --mica-bg: #000000;
            --window-bg: #000000;
            --accent: #00ff00;
            --accent-hover: #00ff00;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --border: #ffffff;
            --table-felt: #000000;
            --tile-face: #000000;
            --tile-back: #000000;
        }
        body.theme-contrast .tile { border: 2px solid #fff; color: #fff; }
        body.theme-contrast .menu-btn { border: 2px solid #fff; }

        body {
            margin: 0;
            background-color: var(--mica-bg);
            color: var(--text-primary);
            font-family: var(--font);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            transition: background 0.3s, color 0.3s;
        }

        /* --- WINDOWS TITLE BAR --- */
        #title-bar {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 12px;
            background: var(--window-bg);
            border-bottom: 1px solid var(--border);
            -webkit-app-region: drag;
        }
        #title-left { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        #title-controls button {
            background: none; border: none; padding: 8px 12px;
            color: var(--text-primary); cursor: pointer;
        }
        #title-controls button:hover { background-color: rgba(0,0,0,0.05); }
        #close-btn:hover { background-color: #e81123 !important; color: white !important; }

        /* --- MAIN LAYOUT --- */
        #app-container {
            display: flex;
            flex: 1;
            height: calc(100% - 40px);
        }

        /* SIDEBAR */
        #sidebar {
            width: 250px;
            background: var(--window-bg);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .nav-item {
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex; align-items: center; gap: 12px;
            font-size: 14px;
            color: var(--text-primary);
            transition: 0.1s;
        }
        .nav-item:hover { background-color: rgba(128,128,128,0.1); }
        .nav-item.active { background-color: var(--accent); color: white; }
        .nav-icon { font-size: 16px; }

        /* GAME VIEW */
        #content-area {
            flex: 1;
            position: relative;
            background: var(--table-felt);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #game-table {
            width: 90vh; height: 90vh;
            max-width: 800px; max-height: 800px;
            position: relative;
        }

        /* --- FLUENT UI ELEMENTS --- */
        .fluent-btn {
            background-color: var(--window-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 24px;
            border-radius: 4px;
            font-family: var(--font);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .fluent-btn:hover { background-color: rgba(128,128,128,0.05); border-color: #bcbcbc; }
        .fluent-btn:active { background-color: rgba(128,128,128,0.1); transform: scale(0.98); }
        
        .fluent-btn.primary {
            background-color: var(--accent);
            color: white;
            border-color: transparent;
        }
        .fluent-btn.primary:hover { background-color: var(--accent-hover); }

        /* --- TILES --- */
        .tile {
            width: 40px; height: 56px;
            background: var(--tile-face);
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.2);
            position: relative;
            cursor: default;
            transition: transform 0.1s cubic-bezier(0,0,0,1);
        }
        .tile-back {
            background: var(--tile-back);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
        }
        .tile-back::after {
            content: 'ðŸ€«'; color: rgba(255,255,255,0.3); font-size: 20px;
        }
        .fresh-tile { margin-left: 24px !important; border-left: 3px solid var(--accent); }

        /* --- PLAYER ZONES --- */
        .hand-container { position: absolute; display: flex; gap: 6px; z-index: 10; }
        .exposed-tiles { display: flex; gap: 4px; margin-right: 10px; }
        .meld { display: flex; gap: 1px; background: rgba(0,0,0,0.1); padding: 4px; border-radius: 4px; }
        
        /* Player 0 (Bottom) */
        #p0-area { bottom: 20px; left: 50%; transform: translateX(-50%); align-items: flex-end; }
        #p0-hand .tile:hover { transform: translateY(-12px); border-color: var(--accent); z-index: 50; cursor: pointer; }

        /* Bots */
        #p1-area { right: 20px; top: 50%; transform: translateY(-50%); flex-direction: column-reverse; align-items: flex-end; }
        #p1-hand, #p1-exposed { flex-direction: column; }
        #p1-area .tile { transform: rotate(-90deg); width: 56px; height: 40px; }

        #p2-area { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row-reverse; align-items: flex-start; }
        #p2-area .tile { transform: rotate(180deg); }

        #p3-area { left: 20px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: flex-start; }
        #p3-hand, #p3-exposed { flex-direction: column; }
        #p3-area .tile { transform: rotate(90deg); width: 56px; height: 40px; }

        /* Discards */
        #discard-pile {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: grid; grid-template-columns: repeat(11, 1fr); gap: 4px;
        }

        /* --- OVERLAYS --- */
        .acrylic-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 10px 24px; border-radius: 8px;
            box-shadow: var(--shadow);
            display: none; gap: 10px; z-index: 200;
            border: 1px solid rgba(0,0,0,0.1);
        }
        body.theme-dark .acrylic-overlay { background: rgba(40, 40, 40, 0.85); border-color: rgba(255,255,255,0.1); }

        #big-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            font-size: 72px; font-weight: 300;
            background: var(--window-bg); padding: 40px 80px;
            border-radius: 12px; box-shadow: var(--shadow);
            text-align: center; opacity: 0; pointer-events: none; transition: 0.3s;
            z-index: 300; border: 1px solid var(--border);
        }
        #big-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        /* --- SETTINGS PAGE --- */
        #settings-page {
            position: absolute; inset: 0; background: var(--mica-bg); z-index: 400;
            display: none; flex-direction: column; padding: 40px;
        }
        .setting-group { background: var(--window-bg); padding: 20px; border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--border); }
        h2 { margin-top: 0; font-weight: 600; }

    </style>
</head>
<body class="theme-light">

    <!-- WINDOWS TITLE BAR -->
    <div id="title-bar">
        <div id="title-left">
            <span>ðŸ€„ Mahjong Solitaire</span>
        </div>
        <div id="title-controls">
            <button>â”€</button>
            <button>â–¡</button>
            <button id="close-btn" onclick="window.close()">Ã—</button>
        </div>
    </div>

    <div id="app-container">
        <!-- SIDEBAR NAVIGATION -->
        <div id="sidebar">
            <div class="nav-item active" onclick="switchTab('play')">
                <span class="nav-icon">â–¶</span> Play
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <span class="nav-icon">âš™</span> Settings
            </div>
            <div style="flex:1"></div>
            <div style="padding:10px; font-size:12px; color:var(--text-secondary)">
                Coins: <strong id="coin-balance" style="color:var(--text-primary)">0</strong>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="content-area">
            
            <!-- GAME TABLE -->
            <div id="game-table">
                <div id="discard-pile"></div>

                <!-- PLAYERS -->
                <div id="p0-area" class="hand-container"><div id="p0-exposed" class="exposed-tiles"></div><div id="p0-hand" class="hand-tiles"></div></div>
                <div id="p1-area" class="hand-container"><div id="p1-exposed" class="exposed-tiles"></div><div id="p1-hand" class="hand-tiles"></div></div>
                <div id="p2-area" class="hand-container"><div id="p2-exposed" class="exposed-tiles"></div><div id="p2-hand" class="hand-tiles"></div></div>
                <div id="p3-area" class="hand-container"><div id="p3-exposed" class="exposed-tiles"></div><div id="p3-hand" class="hand-tiles"></div></div>
            </div>

            <!-- ACTION BAR (Acrylic) -->
            <div id="action-bar" class="acrylic-overlay">
                <button class="fluent-btn primary" onclick="playerAction('hu')">Win (Hu)</button>
                <button class="fluent-btn" onclick="playerAction('kong')">Kong</button>
                <button class="fluent-btn" onclick="playerAction('pung')">Pung</button>
                <button class="fluent-btn" onclick="playerAction('chow')">Chow</button>
                <div style="width:1px; background:#ccc; margin:0 5px;"></div>
                <button class="fluent-btn" onclick="playerAction('skip')">Pass</button>
            </div>

            <!-- BIG MESSAGE OVERLAY -->
            <div id="big-msg">
                <h1 id="msg-title">Victory</h1>
                <p id="msg-sub" style="color:var(--text-secondary)">You won the round.</p>
                <button class="fluent-btn primary" onclick="startGame()" style="margin-top:20px">Play Again</button>
            </div>

            <!-- SETTINGS PAGE -->
            <div id="settings-page">
                <h1>Settings</h1>
                <div class="setting-group">
                    <h2>Appearance</h2>
                    <p>Choose your preferred app theme.</p>
                    <div style="display:flex; gap:10px; margin-top:10px">
                        <button class="fluent-btn" onclick="setTheme('theme-light')">Light</button>
                        <button class="fluent-btn" onclick="setTheme('theme-dark')">Dark</button>
                        <button class="fluent-btn" onclick="setTheme('theme-contrast')">High Contrast</button>
                    </div>
                </div>
                <div class="setting-group">
                    <h2>Data Management</h2>
                    <button class="fluent-btn" onclick="resetData()">Reset All Progress</button>
                </div>
                <button class="fluent-btn primary" onclick="switchTab('play')">Back to Game</button>
            </div>

        </div>
    </div>

<script>
    /* --- MICROSOFT STYLE ENGINE --- */
    const App = {
        data: JSON.parse(localStorage.getItem('msMahjong')) || { coins: 100, theme: 'theme-light' },
        
        init: function() {
            this.applyTheme(this.data.theme);
            this.updateCoins();
            startGame();
        },

        save: function() {
            localStorage.setItem('msMahjong', JSON.stringify(this.data));
            this.updateCoins();
        },

        updateCoins: function() {
            document.getElementById('coin-balance').innerText = this.data.coins;
        },

        applyTheme: function(theme) {
            document.body.className = theme;
            this.data.theme = theme;
            this.save();
        }
    };

    /* --- GAME LOGIC (Ported & Fixed) --- */
    const TILES = {'east':0x1F000,'south':0x1F001,'west':0x1F002,'north':0x1F003,'red':0x1F004,'green':0x1F005,'white':0x1F006,'chars':0x1F007,'bamboo':0x1F010,'dots':0x1F019};
    let deck=[], players=[], exposed=[], discardPile=[], turn=0, lastDiscard=null, paused=false;

    function startGame() {
        // CRITICAL FIX: Hide overlays immediately
        document.getElementById('big-msg').classList.remove('show');
        document.getElementById('action-bar').style.display = 'none';
        
        deck = [];
        ['chars','bamboo','dots'].forEach(t => { for(let i=1;i<=9;i++) for(let k=0;k<4;k++) deck.push({type:t, val:i}); });
        ['east','south','west','north','red','green','white'].forEach(v => { for(let k=0;k<4;k++) deck.push({type:'honor', val:v}); });
        deck.sort(() => Math.random() - 0.5);

        players=[[],[],[],[]]; exposed=[[],[],[],[]]; discardPile=[];
        turn=0; paused=false;

        for(let i=0;i<13;i++) for(let p=0;p<4;p++) players[p].push(deck.pop());
        players[0].sort(tileSort);
        render();
        
        setTimeout(() => drawTile(0), 600);
    }

    function drawTile(pid) {
        if(deck.length===0) return showGameOver(-1);
        const t = deck.pop();
        players[pid].push(t);
        render(pid===0);

        if(pid===0) {
            if(checkWin(players[0])) showActions(true, false, false, false);
        } else {
            setTimeout(() => botTurn(pid), 1500);
        }
    }

    function botTurn(pid) {
        if(checkWin(players[pid])) return showGameOver(pid);
        discard(pid, Math.floor(Math.random()*players[pid].length));
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx, 1)[0];
        lastDiscard = {tile:t, from:pid};
        discardPile.push(t);
        if(pid===0) players[0].sort(tileSort);
        render();
        checkInterrupts(t, pid);
    }

    function checkInterrupts(t, from) {
        if(from !== 0) {
            const h = players[0];
            const hu = checkWin([...h,t]);
            const kong = h.filter(x=>isSame(x,t)).length>=3;
            const pung = h.filter(x=>isSame(x,t)).length>=2;
            const chow = (from===3) && checkChow(h,t);
            
            if(hu||kong||pung||chow) {
                paused = true;
                showActions(hu, kong, pung, chow);
                return;
            }
        }
        
        // Bot Interrupts (Simplified)
        let actor = -1;
        for(let i=1; i<4; i++) {
            if(i!==from && Math.random()<0.1 && players[i].filter(x=>isSame(x,t)).length>=2) actor=i;
        }

        if(actor > -1) {
            paused = true;
            setTimeout(() => {
                removeFromHand(actor, t, 2);
                exposed[actor].push([t,t,t]);
                discardPile.pop();
                render();
                setTimeout(() => discard(actor, 0), 1000);
            }, 1500);
        } else {
            turn = (from+1)%4;
            setTimeout(() => drawTile(turn), 500);
        }
    }

    /* --- USER ACTIONS --- */
    window.playerAction = function(type) {
        document.getElementById('action-bar').style.display = 'none';
        paused = false;

        if(type === 'skip') {
            turn = (lastDiscard.from+1)%4;
            drawTile(turn);
            return;
        }

        const t = lastDiscard.tile;
        discardPile.pop();

        if(type === 'hu') {
            players[0].push(t);
            showGameOver(0);
            return;
        } else if(type === 'pung') {
            removeFromHand(0, t, 2);
            exposed[0].push([t,t,t]);
        } else if(type === 'kong') {
            removeFromHand(0, t, 3);
            exposed[0].push([t,t,t,t]);
            drawTile(0); return;
        } else if(type === 'chow') {
             let h=players[0];
             let t1=h.find(x=>x.type===t.type && x.val===t.val-1);
             let t2=h.find(x=>x.type===t.type && x.val===t.val+1);
             if(t1 && t2) {
                 removeSpec(0,t1); removeSpec(0,t2); exposed[0].push([t1,t,t2].sort(tileSort));
             }
        }
        render();
        turn = 0; // User turn to discard
    };

    /* --- UI UTILS --- */
    function render(fresh=false) {
        document.getElementById('discard-pile').innerHTML = '';
        discardPile.forEach(t => document.getElementById('discard-pile').appendChild(mkTile(t)));

        [0,1,2,3].forEach(pid => {
            const hDiv = document.getElementById(`p${pid}-hand`);
            const eDiv = document.getElementById(`p${pid}-exposed`);
            hDiv.innerHTML = ''; eDiv.innerHTML = '';
            
            exposed[pid].forEach(m => {
                const d = document.createElement('div'); d.className='meld';
                m.forEach(t => d.appendChild(mkTile(t)));
                eDiv.appendChild(d);
            });

            players[pid].forEach((t,i) => {
                if(pid===0) {
                    let el = mkTile(t);
                    if(fresh && i===players[0].length-1) el.classList.add('fresh-tile');
                    el.onclick = () => { if(!paused && turn===0) discard(0,i); };
                    hDiv.appendChild(el);
                } else {
                    let el = document.createElement('div'); el.className='tile tile-back';
                    hDiv.appendChild(el);
                }
            });
        });
    }

    function showActions(h, k, p, c) {
        const bar = document.getElementById('action-bar');
        const btns = bar.children;
        bar.style.display = 'flex';
        btns[0].style.display = h ? 'block' : 'none';
        btns[1].style.display = k ? 'block' : 'none';
        btns[2].style.display = p ? 'block' : 'none';
        btns[3].style.display = c ? 'block' : 'none';
    }

    function showGameOver(winner) {
        const msg = document.getElementById('big-msg');
        const title = document.getElementById('msg-title');
        const sub = document.getElementById('msg-sub');
        
        if(winner === 0) {
            title.innerText = "Victory";
            sub.innerText = "Congratulations! You won 100 coins.";
            App.data.coins += 100;
            App.save();
        } else if(winner === -1) {
            title.innerText = "Draw";
            sub.innerText = "No more tiles in the wall.";
        } else {
            title.innerText = "Defeat";
            sub.innerText = `Bot ${winner} declared victory.`;
        }
        msg.classList.add('show');
    }

    /* --- HELPERS --- */
    function mkTile(t) {
        let el = document.createElement('div'); el.className = `tile ${t.type}`;
        el.innerText = String.fromCodePoint(t.type==='honor'?TILES[t.val]:TILES[t.type]+(t.val-1));
        return el;
    }
    function tileSort(a,b){ const s={'chars':100,'dots':200,'bamboo':300,'honor':400}; return (s[a.type]+(typeof a.val==='string'?10:a.val)) - (s[b.type]+(typeof b.val==='string'?10:b.val)); }
    function checkWin(h) { let m={}; h.forEach(x=>m[x.type+x.val]=(m[x.type+x.val]||0)+1); let p=0; for(let k in m) if(m[k]===2) p++; return p===1 && h.length%3===2; }
    function isSame(a,b){ return a.type===b.type&&a.val===b.val; }
    function checkChow(h,t) { if(t.type==='honor')return false; const x=v=>h.some(z=>z.type===t.type&&z.val===v); return x(t.val-1)&&x(t.val+1); }
    function removeFromHand(p,t,n){ let c=0; players[p]=players[p].filter(x=>{if(c<n&&isSame(x,t)){c++;return false}return true}); }
    function removeSpec(p,t){ let i=players[p].findIndex(x=>isSame(x,t)); if(i>-1)players[p].splice(i,1); }

    /* --- MENU & NAV --- */
    function switchTab(tab) {
        document.getElementById('settings-page').style.display = tab==='settings' ? 'flex' : 'none';
        if(tab==='play') {
            // If game was over, restart it
            if(document.getElementById('big-msg').classList.contains('show')) startGame();
        }
        // Update active sidebar state
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function setTheme(t) { App.applyTheme(t); }
    function resetData() { localStorage.removeItem('msMahjong'); location.reload(); }

    // Init App
    App.init();

</script>
</body>
</html>
