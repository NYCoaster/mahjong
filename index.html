<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong v11: Stable</title>
    <style>
        :root {
            --bg-color: #2d5e3e;
            --table-border: #5c3a21;
            --accent: #ffd700;
            --tile-bg: #fff;
            --tile-border: #999;
            --text-color: white;
        }

        body {
            margin: 0;
            background-color: #121212;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- SKINS --- */
        body.skin-neon {
            --bg-color: #0a0a12; --table-border: #00f3ff; --accent: #00f3ff;
            --tile-bg: #1a1a2e; --tile-border: #ff00ff;
        }
        body.skin-gold {
            --bg-color: #420; --table-border: #f1c40f; --accent: #f1c40f;
            --tile-bg: #fffbe6; --tile-border: #daa520;
        }
        body.skin-sakura {
            --bg-color: #5c2c3b; --table-border: #ffb7b2; --accent: #ff9ff3;
            --tile-bg: #fff0f5; --tile-border: #ffcccc;
        }
        body.skin-glacier {
            --bg-color: #1b262c; --table-border: #bbe1fa; --accent: #3282b8;
            --tile-bg: #f0f8ff; --tile-border: #87ceeb;
        }

        /* --- UI ELEMENTS --- */
        #top-bar {
            height: 60px;
            background: #1a1a1a;
            border-bottom: 2px solid #444;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; z-index: 200;
        }
        .hud-stat { font-size: 20px; font-weight: bold; color: gold; }

        .screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 500; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }

        .menu-btn {
            padding: 15px 60px; margin: 10px; font-size: 22px;
            background: #333; color: white; border: 2px solid #666;
            cursor: pointer; transition: 0.2s; text-transform: uppercase;
            width: 320px;
        }
        .menu-btn:hover { background: var(--accent); color: black; border-color: white; }

        /* --- SHOP --- */
        #shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 20px; margin-bottom: 30px;
        }
        .shop-item {
            background: #222; border: 2px solid #555; padding: 20px;
            text-align: center; cursor: pointer; border-radius: 10px;
            width: 120px; transition: 0.2s;
        }
        .shop-item:hover { transform: translateY(-5px); border-color: white; }
        .shop-item.owned { border-color: #4caf50; }
        .shop-item.active { border-color: var(--accent); background: #444; box-shadow: 0 0 20px var(--accent); }

        /* --- GAME TABLE --- */
        #game-container {
            flex: 1; display: flex; justify-content: center; align-items: center;
            background: #222; position: relative;
        }
        #game-table {
            position: relative;
            width: 90vh; height: 90vh;
            max-width: 800px; max-height: 800px;
            background: var(--bg-color);
            border: 15px solid var(--table-border);
            border-radius: 40px;
            box-shadow: inset 0 0 120px rgba(0,0,0,0.6);
            display: none;
        }

        /* --- TILES --- */
        .tile {
            width: 42px; height: 58px;
            background: var(--tile-bg); color: black;
            border: 1px solid var(--tile-border); border-radius: 5px;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; box-shadow: 3px 4px 8px rgba(0,0,0,0.4);
            position: relative; transition: transform 0.2s;
        }
        .tile-back {
            background: #1e824c; border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.1);
        }
        .fresh-tile {
            margin-left: 25px !important;
            animation: slideLeft 0.4s ease-out;
        }
        @keyframes slideLeft { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- ZONES --- */
        .hand-container { position: absolute; display: flex; gap: 8px; z-index: 10; }
        .exposed-tiles { display: flex; gap: 6px; }
        .hand-tiles { display: flex; gap: 1px; }
        .meld { display: flex; gap: 1px; padding: 0 4px; background: rgba(0,0,0,0.2); border-radius: 4px; }

        #p0-area { bottom: 20px; left: 50%; transform: translateX(-50%); align-items: flex-end; }
        #p0-hand .tile:hover { transform: translateY(-20px); border-color: var(--accent); z-index: 100; cursor: pointer; }

        #p1-area { right: 30px; top: 50%; transform: translateY(-50%); flex-direction: column-reverse; align-items: flex-end; }
        #p1-hand, #p1-exposed { flex-direction: column; }
        #p1-area .tile { transform: rotate(-90deg); width: 58px; height: 42px; }

        #p2-area { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row-reverse; align-items: flex-start; }
        #p2-area .tile { transform: rotate(180deg); }

        #p3-area { left: 30px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: flex-start; }
        #p3-hand, #p3-exposed { flex-direction: column; }
        #p3-area .tile { transform: rotate(90deg); width: 58px; height: 42px; }

        #discard-pile {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: grid; grid-template-columns: repeat(11, 1fr); gap: 4px; z-index: 5;
        }

        /* --- ACTIONS --- */
        #actions { position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); display: none; gap: 15px; z-index: 200; }
        .action-btn { padding: 15px 30px; border-radius: 50px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 0 5px 15px black; }

        #big-msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            font-size: 5em; color: var(--accent); text-shadow: 0 0 20px red; transition: 0.3s;
            pointer-events: none; z-index: 300;
        }
        #big-msg.show { transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body>

<div id="top-bar">
    <div class="hud-stat">ðŸ€„ <span id="wall-count">136</span></div>
    <div class="hud-stat">ðŸ’° <span id="hud-coins">0</span></div>
    <button onclick="showMenu()" style="background:#333; color:#aaa; border:1px solid #555; padding:5px 15px; cursor:pointer">MENU</button>
</div>

<div id="game-container">
    <div id="game-table">
        <div id="big-msg">WIN!</div>
        <div id="discard-pile"></div>

        <div id="actions">
            <button class="action-btn" style="background:red; color:white" onclick="playerAction('hu')">HU!</button>
            <button class="action-btn" style="background:gold; color:black" onclick="playerAction('kong')">KONG</button>
            <button class="action-btn" style="background:cyan; color:black" onclick="playerAction('pung')">PUNG</button>
            <button class="action-btn" style="background:lime; color:black" onclick="playerAction('chow')">CHOW</button>
            <button class="action-btn" style="background:gray; color:white" onclick="playerAction('skip')">PASS</button>
        </div>

        <div id="p0-area" class="hand-container"><div id="p0-exposed" class="exposed-tiles"></div><div id="p0-hand" class="hand-tiles"></div></div>
        <div id="p1-area" class="hand-container"><div id="p1-exposed" class="exposed-tiles"></div><div id="p1-hand" class="hand-tiles"></div></div>
        <div id="p2-area" class="hand-container"><div id="p2-exposed" class="exposed-tiles"></div><div id="p2-hand" class="hand-tiles"></div></div>
        <div id="p3-area" class="hand-container"><div id="p3-exposed" class="exposed-tiles"></div><div id="p3-hand" class="hand-tiles"></div></div>
    </div>
</div>

<div id="main-menu" class="screen">
    <h1 style="color:gold">MAHJONG v11</h1>
    <div id="menu-coins" style="color:#aaa; margin-bottom:20px">Coins: 0</div>
    <button class="menu-btn" onclick="startGame()">PLAY GAME</button>
    <button class="menu-btn" onclick="openShop()">SKIN SHOP</button>
    <button class="menu-btn" onclick="resetData()" style="background:#522; border-color:#844">RESET DATA</button>
</div>

<div id="shop-screen" class="screen hidden">
    <h2>SKIN SHOP</h2>
    <div id="shop-balance" style="color:gold; margin-bottom:10px">Coins: 0</div>
    <div id="shop-grid"></div>
    <button class="menu-btn" onclick="showMenu()">BACK</button>
</div>

<script>
    /* --- AUDIO SYSTEM --- */
    const AudioEngine = {
        ctx: null,
        init: function() { 
            try {
                if(!this.ctx && (window.AudioContext||window.webkitAudioContext)) this.ctx = new (window.AudioContext||window.webkitAudioContext)();
                if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            } catch(e) { console.log("Audio failed", e); }
        },
        beep: function(f, t, d) {
            if (!this.ctx) return;
            try {
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type = t; o.frequency.value = f; g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.linearRampToValueAtTime(0, this.ctx.currentTime + d);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + d);
            } catch(e){}
        },
        click: () => AudioEngine.beep(600,'sine',0.1),
        thock: () => AudioEngine.beep(150,'triangle',0.1),
        alert: () => AudioEngine.beep(400,'square',0.3),
        win: () => [400,500,600,800].forEach((f,i)=>setTimeout(()=>AudioEngine.beep(f,'sine',0.4),i*150)),
        error: () => AudioEngine.beep(150,'sawtooth',0.3)
    };

    /* --- DATA & ECONOMY --- */
    const SKINS = {
        'classic': { name: 'Classic', cost: 0 },
        'skin-neon': { name: 'Neon', cost: 200 },
        'skin-gold': { name: 'Gold', cost: 500 },
        'skin-sakura': { name: 'Sakura', cost: 300 },
        'skin-glacier': { name: 'Glacier', cost: 400 }
    };
    
    let saveData;
    // Load & Repair Data
    try {
        saveData = JSON.parse(localStorage.getItem('mahjongV11'));
        if (!saveData || !saveData.unlocked || !Array.isArray(saveData.unlocked)) throw new Error("Corrupt");
    } catch(e) {
        saveData = { coins: 100, unlocked: ['classic'], activeSkin: 'classic' };
        localStorage.setItem('mahjongV11', JSON.stringify(saveData));
    }

    const TILES = {'east':0x1F000,'south':0x1F001,'west':0x1F002,'north':0x1F003,'red':0x1F004,'green':0x1F005,'white':0x1F006,'chars':0x1F007,'bamboo':0x1F010,'dots':0x1F019};
    let deck=[], players=[], exposed=[], discardPile=[], turn=0, lastDiscard=null, paused=false;

    function resetData() {
        if(confirm("Reset all coins and skins?")) {
            localStorage.removeItem('mahjongV11');
            location.reload();
        }
    }

    /* --- SHOP LOGIC --- */
    function openShop() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('shop-screen').classList.remove('hidden');
        renderShop();
    }

    function renderShop() {
        const grid = document.getElementById('shop-grid');
        document.getElementById('shop-balance').innerText = `Coins: ${saveData.coins}`;
        grid.innerHTML = '';
        
        for (let key in SKINS) {
            let s = SKINS[key];
            let owned = saveData.unlocked.includes(key);
            let active = saveData.activeSkin === key;
            let div = document.createElement('div');
            
            div.className = `shop-item ${owned ? 'owned' : ''} ${active ? 'active' : ''}`;
            div.innerHTML = `<h3>${s.name}</h3><span class="price-tag">${owned ? (active ? 'ACTIVE' : 'OWNED') : s.cost + ' ðŸ’°'}</span>`;
            div.onclick = () => buySkin(key);
            grid.appendChild(div);
        }
    }

    function buySkin(key) {
        if (saveData.unlocked.includes(key)) {
            saveData.activeSkin = key;
            AudioEngine.click();
        } else {
            if (saveData.coins >= SKINS[key].cost) {
                saveData.coins -= SKINS[key].cost;
                saveData.unlocked.push(key);
                saveData.activeSkin = key;
                AudioEngine.win();
            } else {
                AudioEngine.error();
                alert("Need more coins! Win games to earn ðŸ’°.");
                return;
            }
        }
        save();
        applySkin();
        renderShop();
    }

    function save() {
        localStorage.setItem('mahjongV11', JSON.stringify(saveData));
        updateCoinUI();
    }

    function applySkin() { document.body.className = saveData.activeSkin; }
    function updateCoinUI() {
        document.getElementById('menu-coins').innerText = `Coins: ${saveData.coins}`;
        document.getElementById('hud-coins').innerText = saveData.coins;
    }

    /* --- GAME ENGINE --- */
    function startGame() {
        AudioEngine.init();
        document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
        document.getElementById('game-table').style.display='block';
        applySkin();
        resetRound();
    }

    function showMenu() {
        document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
        document.getElementById('main-menu').classList.remove('hidden');
        document.getElementById('game-table').style.display='none';
        updateCoinUI();
    }

    function resetRound() {
        deck=[];
        ['chars','bamboo','dots'].forEach(t=>{for(let i=1;i<=9;i++)for(let k=0;k<4;k++)deck.push({type:t,val:i})});
        ['east','south','west','north','red','green','white'].forEach(v=>{for(let k=0;k<4;k++)deck.push({type:'honor',val:v})});
        deck.sort(()=>Math.random()-0.5);

        players=[[],[],[],[]]; exposed=[[],[],[],[]]; discardPile=[];
        turn=0; paused=false;

        for(let i=0;i<13;i++) for(let p=0;p<4;p++) players[p].push(deck.pop());
        players[0].sort(tileSort);
        render();
        setTimeout(()=>drawTile(0),800);
    }

    function drawTile(pid) {
        if(deck.length===0) return alert("Draw!");
        const t = deck.pop();
        players[pid].push(t);
        AudioEngine.thock();
        render(pid===0);

        if(pid===0) {
            if(checkWin(players[0])) {
                document.getElementById('actions').style.display='flex';
                AudioEngine.alert();
            }
        } else {
            setTimeout(() => botTurn(pid), 2000 + Math.random()*2000);
        }
    }

    function botTurn(pid) {
        if(checkWin(players[pid])) return finish(pid);
        discard(pid, Math.floor(Math.random()*players[pid].length));
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx, 1)[0];
        lastDiscard = {tile:t, from:pid};
        discardPile.push(t);
        AudioEngine.click();
        if(pid===0) players[0].sort(tileSort);
        render();
        checkInterrupts(t, pid);
    }

    function checkInterrupts(t, from) {
        if(from!==0) {
            const h = players[0];
            const hu = checkWin([...h,t]);
            const kong = h.filter(x=>isSame(x,t)).length>=3;
            const pung = h.filter(x=>isSame(x,t)).length>=2;
            const chow = (from===3) && checkChow(h,t);
            
            if(hu||kong||pung||chow) {
                paused=true;
                AudioEngine.alert();
                const btns = document.getElementById('actions').children;
                document.getElementById('actions').style.display='flex';
                btns[0].style.display = hu?'block':'none';
                btns[1].style.display = kong?'block':'none';
                btns[2].style.display = pung?'block':'none';
                btns[3].style.display = chow?'block':'none';
                return;
            }
        }
        
        // Bot Logic
        let actor = -1;
        for(let i=1; i<4; i++) {
            if(i!==from && Math.random()<0.1 && players[i].filter(x=>isSame(x,t)).length>=2) actor=i;
        }
        if(actor>-1) {
            paused=true;
            announce(actor, "PUNG!");
            setTimeout(()=>{
                removeFromHand(actor,t,2); exposed[actor].push([t,t,t]);
                discardPile.pop(); render();
                setTimeout(()=>discard(actor,0), 1500);
            }, 2000);
        } else {
            turn=(from+1)%4; setTimeout(()=>drawTile(turn), 500);
        }
    }

    window.playerAction = function(act) {
        document.getElementById('actions').style.display='none';
        paused=false;
        
        // SMART SKIP: If player skips, still check if bots want it, otherwise next turn
        if(act==='skip') {
             // Trigger bot check manually or just proceed (Simplified: proceed)
             turn=(lastDiscard.from+1)%4; drawTile(turn); return; 
        }
        
        const t = lastDiscard.tile;
        if(act==='hu') return finish(0);
        
        discardPile.pop();
        if(act==='pung') { removeFromHand(0,t,2); exposed[0].push([t,t,t]); }
        else if(act==='kong') { removeFromHand(0,t,3); exposed[0].push([t,t,t,t]); drawTile(0); return; }
        else if(act==='chow') {
             let h=players[0];
             // Enhanced Chow Finder (Start, Middle, End)
             let t1, t2;
             if(has(h,t.type,t.val-1) && has(h,t.type,t.val+1)) { t1=find(h,t.type,t.val-1); t2=find(h,t.type,t.val+1); }
             else if(has(h,t.type,t.val-1) && has(h,t.type,t.val-2)) { t1=find(h,t.type,t.val-1); t2=find(h,t.type,t.val-2); }
             else if(has(h,t.type,t.val+1) && has(h,t.type,t.val+2)) { t1=find(h,t.type,t.val+1); t2=find(h,t.type,t.val+2); }
             
             if(t1 && t2) {
                 removeSpec(0,t1); removeSpec(0,t2); exposed[0].push([t1,t,t2].sort(tileSort));
             }
        }
        render(); turn=0;
    };

    function finish(pid) {
        AudioEngine.win();
        const el = document.getElementById('big-msg');
        el.innerText = pid===0 ? "YOU WIN!" : "BOT "+pid+" WINS!";
        el.classList.add('show');
        if(pid===0) { saveData.coins += 100; save(); }
        setTimeout(showMenu, 4000);
    }

    function announce(pid, txt) {
        const el = document.getElementById('big-msg');
        el.innerText = `BOT ${pid} ${txt}`;
        el.classList.add('show');
        setTimeout(()=>el.classList.remove('show'), 1500);
    }

    /* --- UTILS --- */
    function render(fresh=false) {
        document.getElementById('wall-count').innerText=deck.length;
        const dEl = document.getElementById('discard-pile');
        dEl.innerHTML=''; discardPile.forEach(t=>dEl.appendChild(mkTile(t)));

        [0,1,2,3].forEach(pid=>{
            const hDiv=document.getElementById(`p${pid}-hand`);
            const eDiv=document.getElementById(`p${pid}-exposed`);
            hDiv.innerHTML=''; eDiv.innerHTML='';
            exposed[pid].forEach(m=>{ const d=document.createElement('div'); d.className='meld'; m.forEach(t=>d.appendChild(mkTile(t))); eDiv.appendChild(d); });
            players[pid].forEach((t,i)=>{
                if(pid===0) {
                    let el=mkTile(t);
                    if(fresh && i===players[0].length-1) el.classList.add('fresh-tile');
                    el.onclick=()=>{ if(!paused && turn===0) discard(0,i); };
                    hDiv.appendChild(el);
                } else {
                    let el=document.createElement('div'); el.className='tile tile-back'; hDiv.appendChild(el);
                }
            });
        });
    }

    function mkTile(t) {
        let el=document.createElement('div'); el.className=`tile ${t.type}`; 
        el.innerText=String.fromCodePoint(t.type==='honor'?TILES[t.val]:TILES[t.type]+(t.val-1));
        return el;
    }
    function checkWin(h) { 
        let m={}; h.forEach(x=>m[x.type+x.val]=(m[x.type+x.val]||0)+1);
        let p=0; for(let k in m) if(m[k]===2) p++;
        return p===1 && h.length%3===2;
    }
    function checkChow(h,t) { 
        if(t.type==='honor')return false;
        const x=v=>has(h,t.type,v);
        return (x(t.val-1)&&x(t.val+1)) || (x(t.val-1)&&x(t.val-2)) || (x(t.val+1)&&x(t.val+2));
    }
    
    function has(h,t,v) { return h.some(z=>z.type===t && z.val===v); }
    function find(h,t,v) { return h.find(z=>z.type===t && z.val===v); }
    
    function removeFromHand(p,t,n){ let c=0; players[p]=players[p].filter(x=>{if(c<n&&isSame(x,t)){c++;return false}return true}); }
    function removeSpec(p,t){ let i=players[p].findIndex(x=>isSame(x,t)); if(i>-1)players[p].splice(i,1); }
    function isSame(a,b){ return a.type===b.type&&a.val===b.val; }
    function tileSort(a,b){ const s={'chars':100,'dots':200,'bamboo':300,'honor':400}; return (s[a.type]+(typeof a.val==='string'?10:a.val)) - (s[b.type]+(typeof b.val==='string'?10:b.val)); }

    // Init
    updateCoinUI();
    applySkin();
</script>
</body>
</html>
