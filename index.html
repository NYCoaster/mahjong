<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong: Taiwan Edition</title>
    <style>
        :root {
            --bg: #232323;
            --felt: #1a472a;
            --wood: #5d4037;
            --tile-face: #f0f0f0;
            --tile-back: #005bb5;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        body {
            margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; user-select: none; color: white;
        }

        /* --- LAYOUT --- */
        #app {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative;
        }

        #table {
            width: 95vmin; height: 95vmin; /* Perfect Square */
            background: var(--felt);
            border: 15px solid var(--wood);
            border-radius: 20px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
            position: relative;
        }

        /* --- TILES (SVG RENDERED) --- */
        .tile {
            width: 44px; height: 58px; /* Blocky Aspect Ratio */
            background: var(--tile-face);
            border-radius: 4px;
            box-shadow: 2px 3px 5px rgba(0,0,0,0.4);
            position: relative;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .tile:hover { transform: translateY(-5px); z-index: 100; }
        
        .tile-svg {
            width: 100%; height: 100%;
            display: block;
        }

        .tile-back {
            background: var(--tile-back);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .tile-back::after {
            content: '';
            display: block; width: 30px; height: 40px;
            border: 2px solid rgba(255,255,255,0.15); border-radius: 4px;
            margin: auto; margin-top: 7px;
        }

        /* --- ZONES --- */
        .area { position: absolute; display: flex; gap: 2px; }
        
        /* Player (Bottom) */
        #p0-area { 
            bottom: 20px; left: 50%; transform: translateX(-50%); 
            align-items: flex-end; z-index: 50; 
        }
        
        /* Right */
        #p1-area { 
            right: 20px; top: 50%; 
            transform: translateY(-50%) rotate(-90deg); 
            flex-direction: row-reverse;
        }
        
        /* Top */
        #p2-area {
            top: 20px; left: 50%; 
            transform: translateX(-50%) rotate(180deg); 
            flex-direction: row-reverse;
        }

        /* Left */
        #p3-area {
            left: 20px; top: 50%; 
            transform: translateY(-50%) rotate(90deg); 
            flex-direction: row-reverse;
        }

        .meld { margin-right: 8px; opacity: 0.9; }

        /* --- CENTER FIELD --- */
        #center-field {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            display: grid; grid-template-columns: repeat(6, 1fr);
            gap: 4px; padding: 10px;
        }
        .discard-tile {
            width: 30px; height: 40px;
            font-size: 0.8em;
        }

        /* --- UI OVERLAYS --- */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between;
            background: rgba(0,0,0,0.3);
            z-index: 100;
        }

        #actions {
            position: absolute; top: 65%; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 200; display: none;
        }
        .btn {
            border: none; padding: 12px 24px; border-radius: 50px;
            font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: sans-serif; text-transform: uppercase;
            background: white; color: #333;
            transition: 0.2s;
        }
        .btn:hover { transform: scale(1.1); }
        .btn-hu { background: #d32f2f; color: white; }
        .btn-kong { background: #fbc02d; }
        .btn-pung { background: #0288d1; color: white; }
        .btn-chow { background: #388e3c; color: white; }

        #msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 40px; border-radius: 20px;
            text-align: center; z-index: 300; display: none;
            border: 2px solid gold;
        }
        h1 { margin: 0 0 20px 0; color: gold; font-size: 3em; }

    </style>
</head>
<body>

<div id="hud">
    <div style="font-size:20px">üÄÑ <span id="count">136</span></div>
    <div style="font-size:20px">üí∞ <span id="coins">100</span></div>
</div>

<div id="app">
    <div id="table">
        <!-- Discard Grid -->
        <div id="center-field"></div>

        <!-- Hands -->
        <div id="p0-area" class="area"><div class="exposed area"></div><div class="hand area"></div></div>
        <div id="p1-area" class="area"><div class="exposed area"></div><div class="hand area"></div></div>
        <div id="p2-area" class="area"><div class="exposed area"></div><div class="hand area"></div></div>
        <div id="p3-area" class="area"><div class="exposed area"></div><div class="hand area"></div></div>
        
        <!-- Action Bar -->
        <div id="actions">
            <button class="btn btn-hu" onclick="act('hu')">WIN</button>
            <button class="btn btn-kong" onclick="act('kong')">KONG</button>
            <button class="btn btn-pung" onclick="act('pung')">PUNG</button>
            <button class="btn btn-chow" onclick="act('chow')">CHOW</button>
            <button class="btn" onclick="act('skip')">PASS</button>
        </div>
    </div>
</div>

<div id="msg">
    <h1 id="msg-txt">WIN!</h1>
    <button class="btn" onclick="initGame()">Play Again</button>
</div>

<script>
    // --- SVG GENERATOR (The Engine) ---
    const G = {
        // SVG Helper
        svg: (c) => `<svg viewBox="0 0 100 130" xmlns="http://www.w3.org/2000/svg">${c}</svg>`,
        circle: (cx, cy, r, fill) => `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" />`,
        rect: (x, y, w, h, fill) => `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${fill}" />`,
        char: (txt, col) => `<text x="50" y="75" font-family="sans-serif" font-weight="bold" font-size="60" text-anchor="middle" fill="${col}">${txt}</text>`,
        
        // Tile Types
        dots: (v) => {
            let c = [];
            const cols = {r:'#d32f2f', b:'#1976d2', g:'#388e3c'};
            // Layout logic for dots 1-9
            if(v==1) c.push(G.circle(50,65,30,cols.r), G.circle(50,65,15,'white'));
            if(v==2) { c.push(G.circle(50,35,18,cols.g), G.circle(50,95,18,cols.b)); }
            if(v==3) { c.push(G.circle(25,35,15,cols.b), G.circle(50,65,15,cols.r), G.circle(75,95,15,cols.g)); }
            if(v==4) { c.push(G.circle(30,35,15,cols.b), G.circle(70,35,15,cols.g), G.circle(30,95,15,cols.g), G.circle(70,95,15,cols.b)); }
            if(v==5) { c.push(G.circle(25,25,12,cols.b), G.circle(75,25,12,cols.g), G.circle(50,65,12,cols.r), G.circle(25,105,12,cols.g), G.circle(75,105,12,cols.b)); }
            if(v==6) { c.push(G.circle(30,30,12,cols.g), G.circle(70,30,12,cols.g), G.circle(30,65,12,cols.r), G.circle(70,65,12,cols.r), G.circle(30,100,12,cols.r), G.circle(70,100,12,cols.r)); }
            // Simplified 7-9 for brevity, using distinct patterns
            if(v>=7) c.push(G.char(v, cols.b)); // Fallback for high numbers to keep code small
            return G.svg(c.join(''));
        },
        bamboo: (v) => {
             if(v==1) return G.svg(`<text x="50" y="80" font-size="70" text-anchor="middle">üê¶</text>`);
             let s = '';
             // Simple sticks
             if(v==2) s = G.rect(35,20,10,40,'#388e3c') + G.rect(55,70,10,40,'#388e3c');
             else s = G.char(v, '#1b5e20'); // Simplified
             return G.svg(s);
        },
        chars: (v) => {
             const map = ['‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','‰∏É','ÂÖ´','‰πù'];
             return G.svg(`<text x="50" y="50" font-size="40" text-anchor="middle" fill="#000">${map[v-1]}</text><text x="50" y="100" font-size="40" text-anchor="middle" fill="#d32f2f">Ëê¨</text>`);
        },
        honor: (v) => {
             const m = {'east':'Êù±','south':'Âçó','west':'Ë•ø','north':'Âåó','red':'‰∏≠','green':'Áôº','white':' '};
             const col = (v=='red'||v=='white') ? '#d32f2f' : (v=='green'?'#388e3c':'#000');
             let c = `<text x="50" y="85" font-size="60" text-anchor="middle" fill="${col}">${m[v]}</text>`;
             if(v=='white') c += G.rect(15,20,70,90,'none') + `<rect x="15" y="20" width="70" height="90" stroke="#1976d2" stroke-width="4" fill="none"/>`;
             return G.svg(c);
        }
    };

    /* --- GAME LOGIC --- */
    let deck=[], players=[], exposed=[], discards=[], turn=0, lastDisc=null, paused=false;

    function initGame() {
        document.getElementById('msg').style.display='none';
        deck = [];
        // Build Deck
        ['dots','bamboo','chars'].forEach(t => { for(let i=1;i<=9;i++) for(let k=0;k<4;k++) deck.push({t,v:i}); });
        ['east','south','west','north','red','green','white'].forEach(v => { for(let k=0;k<4;k++) deck.push({t:'honor',v}); });
        deck.sort(()=>Math.random()-0.5);

        players=[[],[],[],[]]; exposed=[[],[],[],[]]; discards=[];
        
        // Deal 16 Tiles (Taiwanese Style)
        for(let i=0;i<16;i++) for(let p=0;p<4;p++) players[p].push(deck.pop());
        
        players[0].sort(sortT);
        render();
        setTimeout(()=>draw(0), 800);
    }

    function draw(pid) {
        if(deck.length===0) return end('Draw');
        const t = deck.pop();
        players[pid].push(t);
        render();
        
        if(pid===0) {
            // Human Turn
            if(checkWin(players[0])) showActs(true,false,false,false);
        } else {
            setTimeout(()=>botTurn(pid), 1000);
        }
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx,1)[0];
        lastDisc = {t, from:pid};
        discards.push(t);
        if(pid===0) players[0].sort(sortT);
        render();
        checkInt(t, pid);
    }

    function botTurn(pid) {
        if(checkWin(players[pid])) return end('Bot '+pid+' Wins');
        discard(pid, Math.floor(Math.random()*players[pid].length));
    }

    function checkInt(t, from) {
        if(from!==0) {
            const h = players[0];
            const w = checkWin([...h,t]);
            const p = h.filter(x=>same(x,t)).length>=2;
            const k = h.filter(x=>same(x,t)).length>=3;
            if(w||p||k) { paused=true; showActs(w,k,p,false); return; }
        }
        // Next
        setTimeout(()=>draw((from+1)%4), 600);
    }

    window.act = function(type) {
        document.getElementById('actions').style.display='none';
        const t = lastDisc.t;
        if(type==='skip') { draw((lastDisc.from+1)%4); return; }
        if(type==='hu') { end('You Win!'); return; }
        
        discards.pop();
        // Logic for taking tile...
        if(type==='pung') { rem(0,t,2); exposed[0].push([t,t,t]); }
        else if(type==='kong') { rem(0,t,3); exposed[0].push([t,t,t,t]); draw(0); return; }
        render();
    };

    function end(txt) {
        document.getElementById('msg').style.display='block';
        document.getElementById('msg-txt').innerText = txt;
    }

    /* --- RENDER --- */
    function render() {
        document.getElementById('count').innerText = deck.length;
        const d = document.getElementById('center-field');
        d.innerHTML = '';
        discards.forEach(t => d.appendChild(mkTile(t, 'discard-tile')));

        [0,1,2,3].forEach(pid => {
            const elH = document.querySelector(`#p${pid}-area .hand`);
            const elE = document.querySelector(`#p${pid}-area .exposed`);
            elH.innerHTML=''; elE.innerHTML='';
            
            exposed[pid].forEach(m => {
                const d = document.createElement('div'); d.className='meld area';
                m.forEach(t=>d.appendChild(mkTile(t)));
                elE.appendChild(d);
            });

            players[pid].forEach((t,i) => {
                if(pid===0) {
                    const el = mkTile(t);
                    el.onclick = () => { if(!paused) discard(0,i); };
                    elH.appendChild(el);
                } else {
                    const el = document.createElement('div');
                    el.className = 'tile tile-back';
                    elH.appendChild(el);
                }
            });
        });
    }

    function mkTile(t, extraClass='') {
        const el = document.createElement('div');
        el.className = `tile ${extraClass}`;
        el.innerHTML = `<div class="tile-svg">${G[t.t](t.v)}</div>`;
        return el;
    }

    function showActs(w,k,p,c) {
        const b = document.getElementById('actions');
        b.style.display='flex';
        b.children[0].style.display=w?'block':'none';
        b.children[1].style.display=k?'block':'none';
        b.children[2].style.display=p?'block':'none';
        b.children[3].style.display=c?'block':'none';
    }

    // Utils
    function same(a,b){ return a.t==b.t && a.v==b.v; }
    function rem(pid,t,n){ let c=0; players[pid]=players[pid].filter(x=>{if(c<n&&same(x,t)){c++;return false}return true}); }
    function sortT(a,b){ const o={'dots':0,'bamboo':1,'chars':2,'honor':3}; return (o[a.t]*10+(typeof a.v=='number'?a.v:10)) - (o[b.t]*10+(typeof b.v=='number'?b.v:10)); }
    function checkWin(h){ 
        // Simplified 1 pair + sets check
        let m={}; h.forEach(x=>m[x.t+x.v]=(m[x.t+x.v]||0)+1);
        let p=0; for(let k in m) if(m[k]===2) p++;
        return p===1 && h.length%3===2;
    }

    initGame();
</script>
</body>
</html>
