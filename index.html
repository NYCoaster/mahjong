<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong Ultimate v16</title>
    <style>
        :root {
            /* --- FLUENT DESIGN TOKENS --- */
            --mica: #f3f3f3;
            --surface: #ffffff;
            --border: #e5e5e5;
            --text: #202020;
            --accent: #0078d4;
            --shadow: 0 8px 20px rgba(0,0,0,0.1);
            
            /* --- GAME TOKENS --- */
            --felt: #1a472a;
            --wood: #5d4037;
            --tile-face: #fcfcfc;
            --tile-back: #005a9e;
            --tile-border: #cccccc;
        }

        /* DARK / NEON THEME */
        body.skin-neon {
            --mica: #101010;
            --surface: #202020;
            --border: #333;
            --text: #fff;
            --accent: #00f3ff;
            --felt: #050510;
            --wood: #00f3ff;
            --tile-face: #1a1a2e;
            --tile-back: #000;
            --tile-border: #00f3ff;
        }
        body.skin-neon .tile svg { filter: drop-shadow(0 0 2px var(--accent)); }

        /* GOLD THEME */
        body.skin-gold {
            --mica: #2d2010;
            --surface: #3e2a18;
            --border: #5d4037;
            --text: #ffd700;
            --accent: #ffd700;
            --felt: #4a0404;
            --wood: #ffd700;
            --tile-face: #fffbe6;
            --tile-back: #b8860b;
            --tile-border: #daa520;
        }

        body {
            margin: 0; background: var(--mica); color: var(--text);
            font-family: 'Segoe UI Variable', 'Segoe UI', sans-serif;
            height: 100vh; display: flex; overflow: hidden; user-select: none;
            transition: background 0.3s;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 260px; background: var(--surface); border-right: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 5px;
            z-index: 100;
        }

        .nav-item {
            padding: 12px 16px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 15px; font-size: 15px;
            transition: 0.1s;
        }
        .nav-item:hover { background: rgba(128,128,128,0.1); }
        .nav-item.active {
            background: var(--accent); color: white; font-weight: 600;
        }

        /* --- MAIN CONTENT --- */
        #main {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* PAGES */
        .page {
            position: absolute; inset: 0; background: var(--mica);
            display: none; flex-direction: column; padding: 40px; overflow-y: auto;
        }
        .page.active { display: flex; }
        #game-page { padding: 0; align-items: center; justify-content: center; background: #111; }

        /* --- GAME TABLE (SQUARE) --- */
        #table {
            width: 96vmin; height: 96vmin;
            background: var(--felt);
            border: 15px solid var(--wood);
            border-radius: 30px;
            position: relative;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }

        /* --- TILE GRAPHICS --- */
        .tile {
            width: 45px; height: 60px; /* 3:4 Ratio */
            background: var(--tile-face);
            border: 1px solid var(--tile-border);
            border-radius: 4px;
            box-shadow: 2px 3px 6px rgba(0,0,0,0.3);
            position: relative; cursor: pointer; transition: transform 0.1s;
        }
        .tile:hover { transform: translateY(-10px); z-index: 100; border-color: var(--accent); }
        
        .tile svg { width: 100%; height: 100%; display: block; }
        
        .tile-back {
            width: 45px; height: 60px;
            background: var(--tile-back);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        
        /* Helpers */
        .corner-idx {
            position: absolute; top: 2px; left: 3px;
            font-size: 10px; font-weight: bold; color: #000; opacity: 0.6;
        }

        /* --- PLAYER ZONES --- */
        .zone { position: absolute; display: flex; gap: 2px; justify-content: center; align-items: flex-end; }
        
        /* P0 (Bottom) */
        #p0 { bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; height: 70px; }
        
        /* P1 (Right) */
        #p1 { right: 10px; top: 50%; transform: translateY(-50%) rotate(-90deg); width: 90%; height: 70px; flex-direction: row-reverse; }
        
        /* P2 (Top) */
        #p2 { top: 15px; left: 50%; transform: translateX(-50%) rotate(180deg); width: 90%; height: 70px; flex-direction: row-reverse; }
        
        /* P3 (Left) */
        #p3 { left: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); width: 90%; height: 70px; flex-direction: row-reverse; }

        /* --- DISCARDS --- */
        #center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 36%; height: 36%;
            border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px;
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px;
            padding: 8px; align-content: center;
        }
        .mini-tile { width: 100%; height: 100%; background: var(--tile-face); border-radius: 2px; display: flex; align-items: center; justify-content: center; }
        .mini-tile svg { width: 80%; height: 80%; }

        /* --- ACTIONS --- */
        #action-bar {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            display: none; gap: 10px; z-index: 200;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 50px;
            backdrop-filter: blur(10px);
        }
        .btn {
            border: none; padding: 10px 24px; border-radius: 20px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--surface); color: var(--text); border: 1px solid var(--border);
        }
        .btn:hover { background: var(--accent); color: white; }
        .btn-hu { background: #d32f2f; color: white; }

        /* --- SHOP GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;
        }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
        .card.owned { border-bottom: 4px solid #4caf50; }
        .card.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- NOTIFICATIONS --- */
        #msg {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: none; justify-content: center; align-items: center;
            flex-direction: column; z-index: 500;
        }
        h1.win { font-size: 4em; color: #ffd700; text-shadow: 0 0 30px orange; }

    </style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <h2 style="margin:0 0 20px 0; color:var(--accent)">üÄÑ Mahjong</h2>
    
    <div class="nav-item active" onclick="nav('game')">‚ñ∂ Play Game</div>
    <div class="nav-item" onclick="nav('shop')">üõí Skin Shop</div>
    <div class="nav-item" onclick="nav('settings')">‚öô Settings</div>
    
    <div style="flex:1"></div>
    <div style="padding:15px; background:rgba(0,0,0,0.05); border-radius:8px">
        <div style="font-size:12px; opacity:0.7">YOUR COINS</div>
        <div style="font-size:24px; font-weight:bold" id="coin-display">0</div>
    </div>
</div>

<!-- MAIN -->
<div id="main">

    <!-- GAME PAGE -->
    <div id="page-game" class="page active">
        <div id="table">
            <div id="center"></div>
            <!-- Hands -->
            <div id="p0" class="zone"></div>
            <div id="p1" class="zone"></div>
            <div id="p2" class="zone"></div>
            <div id="p3" class="zone"></div>
            
            <!-- Actions -->
            <div id="action-bar">
                <button class="btn btn-hu" onclick="act('hu')">WIN (HU)</button>
                <button class="btn" onclick="act('kong')">Kong</button>
                <button class="btn" onclick="act('pung')">Pung</button>
                <button class="btn" onclick="act('chow')">Chow</button>
                <button class="btn" onclick="act('skip')">Pass</button>
            </div>
        </div>
        <!-- Notification -->
        <div id="msg">
            <h1 class="win" id="msg-txt">VICTORY</h1>
            <button class="btn" style="padding:15px 40px; font-size:18px" onclick="location.reload()">New Game</button>
        </div>
    </div>

    <!-- SHOP PAGE -->
    <div id="page-shop" class="page">
        <h1>Skin Shop</h1>
        <p>Customize your board. Unlocked items are saved automatically.</p>
        <div id="shop-grid" class="grid"></div>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="page-settings" class="page">
        <h1>Settings</h1>
        <button class="btn" onclick="resetData()" style="background:#d32f2f; color:white; width:200px">Reset All Data</button>
    </div>

</div>

<script>
    /* --- 1. SVG TILE ENGINE --- */
    const SVG = {
        base: (c) => `<svg viewBox="0 0 100 130">${c}</svg>`,
        circle: (x,y,r,c) => `<circle cx="${x}" cy="${y}" r="${r}" fill="${c}"/>`,
        rect: (x,y,w,h,c) => `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${c}"/>`,
        get: (t, v) => {
            let g=''; const R='#d32f2f', G='#2e7d32', B='#1565c0';
            let idx = ''; // Corner number for readability
            
            if(t==='dots') {
                if(v==1) g = SVG.circle(50,65,35,R)+SVG.circle(50,65,20,'white')+SVG.circle(50,65,10,R);
                else if(v==2) g = SVG.circle(50,35,18,G)+SVG.circle(50,95,18,B);
                else if(v==3) g = SVG.circle(25,30,15,B)+SVG.circle(50,65,15,R)+SVG.circle(75,100,15,G);
                else if(v==4) g = SVG.circle(30,30,15,B)+SVG.circle(70,30,15,G)+SVG.circle(30,100,15,G)+SVG.circle(70,100,15,B);
                else if(v==5) g = SVG.circle(25,25,12,B)+SVG.circle(75,25,12,G)+SVG.circle(50,65,12,R)+SVG.circle(25,105,12,G)+SVG.circle(75,105,12,B);
                else g = `<text x="50" y="85" font-size="60" text-anchor="middle" fill="${B}" font-weight="bold" font-family="serif">${v}</text>`;
            } 
            else if(t==='bamboo') {
                if(v==1) g = `<path d="M50,50 Q30,70 20,60 Q40,40 50,30 Q60,40 80,60 Q70,70 50,50 M50,70 L50,110 M30,110 L70,110" stroke="${G}" stroke-width="5" fill="none"/>`;
                else g = `<rect x="35" y="25" width="10" height="80" fill="${G}"/><rect x="55" y="25" width="10" height="80" fill="${G}"/>`;
            }
            else if(t==='chars') {
                const ch = ['‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','‰∏É','ÂÖ´','‰πù'];
                g = `<text x="50" y="60" font-size="45" text-anchor="middle" fill="#000" font-family="serif">${ch[v-1]}</text><text x="50" y="115" font-size="40" text-anchor="middle" fill="${R}" font-family="serif">Ëê¨</text>`;
                idx = `<span class="corner-idx">${v}</span>`; // Add helper number
            }
            else {
                const h = {'east':'Êù±','south':'Âçó','west':'Ë•ø','north':'Âåó','red':'‰∏≠','green':'Áôº','white':' '};
                const col = (v=='red'||v=='white')?R:(v=='green'?G:'#000');
                g = `<text x="50" y="95" font-size="70" text-anchor="middle" fill="${col}" font-family="serif">${h[v]}</text>`;
                if(v=='white') g+=`<rect x="10" y="10" width="80" height="110" stroke="${B}" stroke-width="4" fill="none"/>`;
                idx = `<span class="corner-idx">${v[0].toUpperCase()}</span>`;
            }
            return idx + SVG.base(g);
        }
    };

    /* --- 2. APP STATE & SHOP --- */
    const App = {
        data: JSON.parse(localStorage.getItem('mahjongUlt')) || { coins: 100, unlocked:['classic'], skin:'classic' },
        save() { localStorage.setItem('mahjongUlt', JSON.stringify(this.data)); this.update(); },
        update() { 
            document.getElementById('coin-display').innerText = this.data.coins; 
            document.body.className = this.data.skin;
        }
    };

    const SKINS = {
        'classic': {name:'Classic Green', cost:0},
        'skin-neon': {name:'Cyber Neon', cost:200},
        'skin-gold': {name:'Emperor Gold', cost:500}
    };

    function loadShop() {
        const g = document.getElementById('shop-grid'); g.innerHTML='';
        for(let k in SKINS) {
            let s = SKINS[k];
            let owned = App.data.unlocked.includes(k);
            let active = App.data.skin === k;
            let el = document.createElement('div');
            el.className = `card ${active?'active':(owned?'owned':'')}`;
            el.innerHTML = `<h3>${s.name}</h3><p>${owned?(active?'ACTIVE':'OWNED'):s.cost+' üí∞'}</p>`;
            el.onclick = () => {
                if(owned) { App.data.skin=k; }
                else if(App.data.coins>=s.cost) { App.data.coins-=s.cost; App.data.unlocked.push(k); App.data.skin=k; }
                else { alert('Not enough coins!'); return; }
                App.save(); loadShop();
            };
            g.appendChild(el);
        }
    }

    /* --- 3. GAME LOGIC --- */
    let deck=[], players=[], discards=[], turn=0, paused=false, lastT=null;

    function initGame() {
        deck=[];
        ['dots','bamboo','chars'].forEach(t=>{for(let i=1;i<=9;i++)for(let k=0;k<4;k++)deck.push({t,v:i})});
        ['east','south','west','north','red','green','white'].forEach(v=>{for(let k=0;k<4;k++)deck.push({t:'honor',v})});
        deck.sort(()=>Math.random()-0.5);

        players=[[],[],[],[]]; discards=[];
        // 16 Tiles
        for(let i=0;i<16;i++) for(let p=0;p<4;p++) players[p].push(deck.pop());
        
        players[0].sort(sortT);
        render();
        setTimeout(()=>draw(0), 800);
    }

    function draw(pid) {
        if(deck.length===0) return end('DRAW');
        const t = deck.pop();
        players[pid].push(t);
        render(pid===0);

        if(pid===0) {
            if(checkWin(players[0])) showActs(true,false,false,false);
        } else {
            setTimeout(()=>discard(pid, Math.floor(Math.random()*players[pid].length)), 1000);
        }
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx,1)[0];
        lastT = {t, from:pid};
        discards.push(t);
        if(pid===0) players[0].sort(sortT);
        render();
        
        if(pid!==0) {
            const h = players[0];
            // Simplified Logic
            const w=checkWin([...h,t]);
            const p=h.filter(x=>same(x,t)).length>=2;
            if(w||p) { paused=true; showActs(w,false,p,false); return; }
        }
        setTimeout(()=>draw((pid+1)%4), 600);
    }

    window.act = function(type) {
        document.getElementById('action-bar').style.display='none';
        paused=false;
        if(type==='hu') return end("YOU WIN!");
        if(type==='skip') { draw((lastT.from+1)%4); return; }
        
        // Action execution (Mock)
        discards.pop();
        players[0].push(lastT.t);
        players[0].sort(sortT);
        render();
    }

    function render(fresh=false) {
        const d = document.getElementById('center');
        d.innerHTML=''; discards.forEach(t=>{ let el=mkTile(t,'mini-tile'); d.appendChild(el); });

        const p0 = document.getElementById('p0');
        p0.innerHTML='';
        players[0].forEach((t,i) => {
            let el=mkTile(t,'tile');
            if(fresh && i===players[0].length-1) el.style.marginLeft='20px';
            el.onclick=()=>{if(!paused && players[0].length%3===2) discard(0,i)};
            p0.appendChild(el);
        });

        [1,2,3].forEach(pid => {
            const z = document.getElementById('p'+pid);
            z.innerHTML='';
            players[pid].forEach(()=>{ let el=document.createElement('div'); el.className='tile-back'; z.appendChild(el); });
        });
    }

    function mkTile(t, cls) {
        let el = document.createElement('div'); el.className=cls;
        el.innerHTML = SVG.get(t.t, t.v);
        return el;
    }

    function end(txt) {
        document.getElementById('msg').style.display='flex';
        document.getElementById('msg-txt').innerText=txt;
        if(txt.includes('WIN')) { App.data.coins+=100; App.save(); }
    }

    function nav(page) {
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('page-'+page).classList.add('active');
        event.target.classList.add('active');
        if(page==='shop') loadShop();
    }
    
    function showActs(w,k,p,c) { document.getElementById('action-bar').style.display='flex'; }
    function sortT(a,b){ const o={'dots':0,'bamboo':1,'chars':2,'honor':3}; return (o[a.t]*10+(a.v||10))-(o[b.t]*10+(b.v||10)); }
    function checkWin(h){ return h.length%3===2 && Math.random()>0.9; } // Demo Win Check
    function same(a,b){ return a.t==b.t && a.v==b.v; }
    function resetData() { localStorage.clear(); location.reload(); }

    // INIT
    App.update();
    initGame();
</script>
</body>
</html>
