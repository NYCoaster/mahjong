<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong Solitaire: Ultimate</title>
    <style>
        :root {
            /* --- FLUENT DESIGN SYSTEM --- */
            --mica-bg: #f3f3f3;
            --window-bg: #ffffff;
            --accent: #0078d4;
            --text-primary: #202020;
            --text-secondary: #606060;
            --border: #e5e5e5;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --font: 'Segoe UI Variable', 'Segoe UI', sans-serif;
            
            /* Game Tokens */
            --table-felt: #2d5e3e;
            --tile-face: #ffffff;
            --tile-back: #2b5797;
            --tile-border: #ccc;
        }

        /* --- SKINS (Theming) --- */
        body.skin-neon {
            --mica-bg: #000000;
            --window-bg: #111111;
            --accent: #00f3ff;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #333;
            --table-felt: #050510;
            --tile-face: #1a1a2e;
            --tile-back: #000000;
            --tile-border: #00f3ff;
        }
        body.skin-neon .tile { color: #00f3ff; text-shadow: 0 0 5px #00f3ff; }

        body.skin-gold {
            --mica-bg: #2d2010;
            --window-bg: #3e2a18;
            --accent: #ffd700;
            --text-primary: #fff8e1;
            --border: #5d4037;
            --table-felt: #420;
            --tile-face: #fffbe6;
            --tile-back: #ffd700;
            --tile-border: #b8860b;
        }

        body {
            margin: 0; background-color: var(--mica-bg); color: var(--text-primary);
            font-family: var(--font); display: flex; flex-direction: column;
            height: 100vh; overflow: hidden; user-select: none;
            transition: background 0.3s, color 0.3s;
        }

        /* --- TITLE BAR --- */
        #title-bar {
            height: 40px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; background: var(--window-bg); border-bottom: 1px solid var(--border);
            font-size: 12px; -webkit-app-region: drag;
        }
        #title-controls button {
            background: none; border: none; color: var(--text-primary); padding: 8px 12px;
            cursor: pointer; -webkit-app-region: no-drag;
        }
        #title-controls button:hover { background: rgba(128,128,128,0.1); }
        #btn-close:hover { background: #e81123 !important; color: white !important; }

        /* --- LAYOUT --- */
        #app-body { display: flex; flex: 1; height: calc(100% - 40px); }

        #sidebar {
            width: 260px; background: var(--window-bg); border-right: 1px solid var(--border);
            padding: 12px; display: flex; flex-direction: column; gap: 4px;
        }
        .nav-item {
            padding: 10px 12px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; gap: 12px; font-size: 14px;
            color: var(--text-primary); transition: 0.1s;
        }
        .nav-item:hover { background: rgba(128,128,128,0.05); }
        .nav-item.active { background: rgba(128,128,128,0.1); font-weight: 600; }
        .nav-item.active::before {
            content: ''; position: absolute; left: 12px; height: 16px;
            width: 3px; background: var(--accent); border-radius: 2px;
        }

        #main-view { flex: 1; position: relative; overflow: hidden; background: var(--mica-bg); }

        /* --- PAGES --- */
        .page { position: absolute; inset: 0; display: none; flex-direction: column; }
        .page.active { display: flex; }
        
        /* GAME PAGE */
        #game-page { background: var(--table-felt); align-items: center; justify-content: center; }
        #game-table { width: 90vh; height: 90vh; max-width: 800px; position: relative; }

        /* SHOP & SETTINGS PAGES */
        .content-page { padding: 40px; overflow-y: auto; }
        h1 { font-weight: 300; font-size: 28px; margin-bottom: 24px; }
        h2 { font-size: 18px; margin-bottom: 12px; }
        p { color: var(--text-secondary); font-size: 14px; line-height: 1.5; }

        /* SHOP GRID */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;
        }
        .card {
            background: var(--window-bg); border: 1px solid var(--border);
            border-radius: 6px; padding: 16px; text-align: center;
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--accent); }
        .card.owned { border-bottom: 4px solid var(--border); }
        .card.equipped { border-bottom: 4px solid var(--accent); background: rgba(0,120,212,0.03); }
        
        .price-tag {
            display: inline-block; background: var(--mica-bg); padding: 4px 8px;
            border-radius: 4px; font-size: 12px; font-weight: 600; margin-top: 8px;
        }

        /* --- COMPONENTS --- */
        .fluent-btn {
            background: var(--window-bg); border: 1px solid var(--border);
            color: var(--text-primary); padding: 6px 20px; border-radius: 4px;
            font-size: 14px; cursor: pointer; transition: 0.1s;
        }
        .fluent-btn:hover { background: rgba(128,128,128,0.05); }
        .fluent-btn.primary { background: var(--accent); color: white; border-color: transparent; }
        .fluent-btn.primary:hover { filter: brightness(1.1); }

        /* --- TILES & GAMEPLAY --- */
        .tile {
            width: 40px; height: 56px; background: var(--tile-face);
            border: 1px solid var(--tile-border); border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; box-shadow: 2px 4px 8px rgba(0,0,0,0.2);
            position: relative; cursor: default; transition: 0.1s;
        }
        .tile-back { background: var(--tile-back); display: flex; justify-content: center; align-items: center; }
        .tile-back::after { content: 'ðŸ€«'; color: rgba(255,255,255,0.3); font-size: 20px; }
        
        .hand-container { position: absolute; display: flex; gap: 4px; z-index: 10; }
        #p0-area { bottom: 20px; left: 50%; transform: translateX(-50%); align-items: flex-end; }
        #p0-hand .tile:hover { transform: translateY(-15px); border-color: var(--accent); z-index: 100; cursor: pointer; }
        
        /* Bots */
        #p1-area { right: 20px; top: 50%; transform: translateY(-50%); flex-direction: column-reverse; align-items: flex-end; }
        #p1-hand, #p1-exposed { flex-direction: column; }
        #p1-area .tile { transform: rotate(-90deg); width: 56px; height: 40px; }
        #p2-area { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row-reverse; align-items: flex-start; }
        #p2-area .tile { transform: rotate(180deg); }
        #p3-area { left: 20px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: flex-start; }
        #p3-hand, #p3-exposed { flex-direction: column; }
        #p3-area .tile { transform: rotate(90deg); width: 56px; height: 40px; }

        #discard-pile {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: grid; grid-template-columns: repeat(11, 1fr); gap: 4px;
        }

        /* --- OVERLAYS --- */
        #action-bar {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 8px; box-shadow: var(--shadow);
            display: none; gap: 8px; z-index: 200; border: 1px solid var(--border);
        }
        body.skin-neon #action-bar { background: rgba(30,30,30,0.9); border-color: #333; }

        #big-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            font-size: 48px; font-weight: 300; background: var(--window-bg);
            padding: 40px 60px; border-radius: 8px; box-shadow: var(--shadow);
            text-align: center; opacity: 0; pointer-events: none; transition: 0.2s;
            z-index: 300; border: 1px solid var(--border);
        }
        #big-msg.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

    </style>
</head>
<body>

    <!-- TITLE BAR -->
    <div id="title-bar">
        <div style="display:flex; gap:10px; align-items:center">
            <span>ðŸ€„ Mahjong Solitaire</span>
            <span style="color:var(--text-secondary); font-size:11px">| Ultimate Edition</span>
        </div>
        <div id="title-controls">
            <button onclick="document.documentElement.requestFullscreen()">â›¶</button>
            <button>â”€</button>
            <button id="btn-close" onclick="window.close()">Ã—</button>
        </div>
    </div>

    <!-- APP BODY -->
    <div id="app-body">
        
        <!-- SIDEBAR -->
        <div id="sidebar">
            <div style="padding:10px 0; font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px">Menu</div>
            
            <div class="nav-item active" onclick="nav('game')">
                <span>â–¶</span> Play Game
            </div>
            <div class="nav-item" onclick="nav('shop')">
                <span>ðŸ›’</span> Skin Shop
            </div>
            <div class="nav-item" onclick="nav('guide')">
                <span>ðŸ“–</span> How to Play
            </div>
            <div class="nav-item" onclick="nav('settings')">
                <span>âš™</span> Settings
            </div>

            <div style="flex:1"></div>
            
            <div style="background:var(--mica-bg); padding:12px; border-radius:6px; margin-top:20px">
                <div style="font-size:11px; color:var(--text-secondary)">WALLET</div>
                <div style="font-size:18px; font-weight:600; color:var(--accent)" id="coin-display">0</div>
            </div>
        </div>

        <!-- MAIN VIEW -->
        <div id="main-view">

            <!-- 1. GAME PAGE -->
            <div id="page-game" class="page active">
                <div id="game-page">
                    <div id="game-table">
                        <div id="discard-pile"></div>
                        
                        <!-- ACTIONS -->
                        <div id="action-bar">
                            <button class="fluent-btn primary" onclick="doAction('hu')">Win (Hu)</button>
                            <button class="fluent-btn" onclick="doAction('kong')">Kong</button>
                            <button class="fluent-btn" onclick="doAction('pung')">Pung</button>
                            <button class="fluent-btn" onclick="doAction('chow')">Chow</button>
                            <div style="width:1px; background:var(--border); margin:0 5px"></div>
                            <button class="fluent-btn" onclick="doAction('skip')">Pass</button>
                        </div>

                        <!-- NOTIFICATION -->
                        <div id="big-msg">
                            <h2 id="msg-title">Victory</h2>
                            <p id="msg-text">You earned 100 coins.</p>
                            <button class="fluent-btn primary" onclick="startGame()" style="margin-top:20px">Play Again</button>
                        </div>

                        <!-- PLAYERS -->
                        <div id="p0-area" class="hand-container"><div id="p0-exposed" style="display:flex;gap:5px"></div><div id="p0-hand" style="display:flex;gap:0"></div></div>
                        <div id="p1-area" class="hand-container"><div id="p1-exposed" style="display:flex;gap:5px"></div><div id="p1-hand" style="display:flex;gap:0"></div></div>
                        <div id="p2-area" class="hand-container"><div id="p2-exposed" style="display:flex;gap:5px"></div><div id="p2-hand" style="display:flex;gap:0"></div></div>
                        <div id="p3-area" class="hand-container"><div id="p3-exposed" style="display:flex;gap:5px"></div><div id="p3-hand" style="display:flex;gap:0"></div></div>
                    </div>
                    
                    <!-- HUD -->
                    <div style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); padding:8px 16px; border-radius:20px; color:white; font-size:14px">
                        Tiles Left: <span id="wall-count">136</span>
                    </div>
                </div>
            </div>

            <!-- 2. SHOP PAGE -->
            <div id="page-shop" class="page content-page">
                <h1>Skin Shop</h1>
                <p>Customize your game board. Unlocked items are yours forever.</p>
                <div id="shop-grid" class="grid" style="margin-top:20px"></div>
            </div>

            <!-- 3. GUIDE PAGE -->
            <div id="page-guide" class="page content-page">
                <h1>How to Play</h1>
                <div class="card" style="text-align:left; max-width:600px">
                    <h2>Basics</h2>
                    <p>Draw a tile, discard a tile. Try to form 4 sets and 1 pair.</p>
                    <h2 style="margin-top:20px">Moves</h2>
                    <ul style="padding-left:20px; color:var(--text-secondary)">
                        <li><strong>Pung:</strong> 3 identical tiles. Can take from anyone.</li>
                        <li><strong>Chow:</strong> Sequence (e.g. 2-3-4). Can only take from Left player.</li>
                        <li><strong>Kong:</strong> 4 identical tiles. Draw a replacement card.</li>
                        <li><strong>Hu:</strong> Victory! Complete hand.</li>
                    </ul>
                </div>
            </div>

            <!-- 4. SETTINGS PAGE -->
            <div id="page-settings" class="page content-page">
                <h1>Settings</h1>
                <div class="card" style="text-align:left; max-width:500px">
                    <h2>Data</h2>
                    <p>Clear all progress, coins, and skins.</p>
                    <button class="fluent-btn" onclick="resetData()" style="border-color:#e81123; color:#e81123">Reset Data</button>
                </div>
            </div>

        </div>
    </div>

<script>
    /* --- APP STATE & LOGIC --- */
    const App = {
        data: JSON.parse(localStorage.getItem('msMahjongV2')) || { 
            coins: 100, unlocked: ['classic'], activeSkin: 'classic' 
        },
        save() {
            localStorage.setItem('msMahjongV2', JSON.stringify(this.data));
            this.updateUI();
        },
        updateUI() {
            document.getElementById('coin-display').innerText = this.data.coins;
            document.body.className = this.data.activeSkin;
        }
    };

    /* --- NAVIGATION --- */
    function nav(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+pageId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        // Highlight current nav item logic here if needed
        
        if(pageId === 'shop') renderShop();
    }

    /* --- SHOP ENGINE --- */
    const SKINS = {
        'classic': { name: 'Classic Windows', cost: 0 },
        'skin-neon': { name: 'Cyber Neon', cost: 200 },
        'skin-gold': { name: 'Emperor Gold', cost: 500 }
    };

    function renderShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        for(let key in SKINS) {
            const s = SKINS[key];
            const owned = App.data.unlocked.includes(key);
            const active = App.data.activeSkin === key;
            
            const card = document.createElement('div');
            card.className = `card ${owned ? 'owned' : ''} ${active ? 'equipped' : ''}`;
            card.innerHTML = `
                <div style="font-size:40px; margin-bottom:10px">ðŸ€„</div>
                <h3>${s.name}</h3>
                <div class="price-tag">${owned ? (active ? 'ACTIVE' : 'OWNED') : s.cost + ' Coins'}</div>
            `;
            card.onclick = () => buySkin(key, s.cost);
            grid.appendChild(card);
        }
    }

    function buySkin(key, cost) {
        if(App.data.unlocked.includes(key)) {
            App.data.activeSkin = key;
        } else {
            if(App.data.coins >= cost) {
                App.data.coins -= cost;
                App.data.unlocked.push(key);
                App.data.activeSkin = key;
            } else {
                alert("Not enough coins!");
                return;
            }
        }
        App.save();
        renderShop();
    }

    function resetData() {
        if(confirm("Reset all data?")) {
            localStorage.removeItem('msMahjongV2');
            location.reload();
        }
    }

    /* --- GAME LOGIC --- */
    const TILES = {'east':0x1F000,'south':0x1F001,'west':0x1F002,'north':0x1F003,'red':0x1F004,'green':0x1F005,'white':0x1F006,'chars':0x1F007,'bamboo':0x1F010,'dots':0x1F019};
    let deck=[], players=[], exposed=[], discardPile=[], turn=0, lastDiscard=null, paused=false;

    function startGame() {
        // Reset UI
        document.getElementById('big-msg').classList.remove('show');
        document.getElementById('action-bar').style.display = 'none';
        
        // Init Deck
        deck = [];
        ['chars','bamboo','dots'].forEach(t=>{for(let i=1;i<=9;i++)for(let k=0;k<4;k++)deck.push({type:t,val:i})});
        ['east','south','west','north','red','green','white'].forEach(v=>{for(let k=0;k<4;k++)deck.push({type:'honor',val:v})});
        deck.sort(()=>Math.random()-0.5);

        players=[[],[],[],[]]; exposed=[[],[],[],[]]; discardPile=[];
        turn=0; paused=false;

        // Deal
        for(let i=0;i<13;i++) for(let p=0;p<4;p++) players[p].push(deck.pop());
        players[0].sort(tileSort);
        render();
        setTimeout(()=>drawTile(0), 800);
    }

    function drawTile(pid) {
        if(deck.length===0) return endGame(-1);
        const t = deck.pop();
        players[pid].push(t);
        render();

        if(pid===0) {
            if(checkWin(players[0])) showActions(true, false, false, false);
        } else {
            setTimeout(()=>botTurn(pid), 1500);
        }
    }

    function botTurn(pid) {
        if(checkWin(players[pid])) return endGame(pid);
        discard(pid, Math.floor(Math.random()*players[pid].length));
    }

    function discard(pid, idx) {
        const t = players[pid].splice(idx, 1)[0];
        lastDiscard = {tile:t, from:pid};
        discardPile.push(t);
        if(pid===0) players[0].sort(tileSort);
        render();
        checkInterrupts(t, pid);
    }

    function checkInterrupts(t, from) {
        if(from !== 0) {
            const h = players[0];
            const hu = checkWin([...h,t]);
            const kong = h.filter(x=>isSame(x,t)).length>=3;
            const pung = h.filter(x=>isSame(x,t)).length>=2;
            const chow = (from===3) && checkChow(h,t);
            
            if(hu||kong||pung||chow) {
                paused = true;
                showActions(hu, kong, pung, chow);
                return;
            }
        }
        // Simple Bot Pung (10% chance)
        let actor = -1;
        for(let i=1; i<4; i++) {
            if(i!==from && Math.random()<0.1 && players[i].filter(x=>isSame(x,t)).length>=2) actor=i;
        }
        if(actor > -1) {
            paused = true;
            setTimeout(()=>{
                removeFromHand(actor,t,2); exposed[actor].push([t,t,t]);
                discardPile.pop(); render();
                setTimeout(()=>discard(actor,0), 1000);
            }, 1000);
        } else {
            turn = (from+1)%4;
            setTimeout(()=>drawTile(turn), 500);
        }
    }

    window.doAction = function(type) {
        document.getElementById('action-bar').style.display='none';
        paused=false;
        const t = lastDiscard.tile;

        if(type==='skip') {
            turn = (lastDiscard.from+1)%4;
            drawTile(turn);
            return;
        }
        
        discardPile.pop();
        if(type==='hu') { players[0].push(t); endGame(0); return; }
        if(type==='pung') { removeFromHand(0,t,2); exposed[0].push([t,t,t]); }
        if(type==='kong') { removeFromHand(0,t,3); exposed[0].push([t,t,t,t]); drawTile(0); return; }
        if(type==='chow') {
             const h=players[0];
             // Simple chow finder
             let t1 = h.find(x=>x.type===t.type && x.val===t.val-1);
             let t2 = h.find(x=>x.type===t.type && x.val===t.val+1);
             if(t1&&t2) { removeSpec(0,t1); removeSpec(0,t2); exposed[0].push([t1,t,t2].sort(tileSort)); }
        }
        render(); turn=0;
    }

    function endGame(winner) {
        const el = document.getElementById('big-msg');
        document.getElementById('msg-title').innerText = winner===0 ? "Victory" : "Defeat";
        document.getElementById('msg-text').innerText = winner===0 ? "You won 100 coins!" : "Bot "+winner+" won.";
        el.classList.add('show');
        if(winner===0) { App.data.coins+=100; App.save(); }
    }

    /* --- UTILS --- */
    function render(fresh=false) {
        document.getElementById('wall-count').innerText = deck.length;
        document.getElementById('discard-pile').innerHTML = '';
        discardPile.forEach(t => document.getElementById('discard-pile').appendChild(mkTile(t)));

        [0,1,2,3].forEach(pid => {
            const hDiv = document.getElementById(`p${pid}-hand`);
            const eDiv = document.getElementById(`p${pid}-exposed`);
            hDiv.innerHTML = ''; eDiv.innerHTML = '';
            
            exposed[pid].forEach(m => {
                const d = document.createElement('div'); d.className='meld';
                m.forEach(t => d.appendChild(mkTile(t)));
                eDiv.appendChild(d);
            });

            players[pid].forEach((t,i) => {
                if(pid===0) {
                    let el = mkTile(t);
                    if(fresh && i===players[0].length-1) el.style.marginLeft = '20px';
                    el.onclick = () => { if(!paused && turn===0) discard(0,i); };
                    hDiv.appendChild(el);
                } else {
                    let el = document.createElement('div'); el.className='tile tile-back'; hDiv.appendChild(el);
                }
            });
        });
    }

    function mkTile(t) {
        let el = document.createElement('div'); el.className = `tile ${t.type}`; 
        el.innerText = String.fromCodePoint(t.type==='honor'?TILES[t.val]:TILES[t.type]+(t.val-1));
        return el;
    }
    function showActions(h,k,p,c) {
        const b = document.getElementById('action-bar');
        b.style.display = 'flex';
        const btns = b.children;
        btns[0].style.display = h?'block':'none';
        btns[1].style.display = k?'block':'none';
        btns[2].style.display = p?'block':'none';
        btns[3].style.display = c?'block':'none';
    }
    function isSame(a,b){ return a.type===b.type&&a.val===b.val; }
    function checkWin(h) { let m={}; h.forEach(x=>m[x.type+x.val]=(m[x.type+x.val]||0)+1); let p=0; for(let k in m) if(m[k]===2) p++; return p===1 && h.length%3===2; }
    function checkChow(h,t) { if(t.type==='honor')return false; const x=v=>h.some(z=>z.type===t.type&&z.val===v); return x(t.val-1)&&x(t.val+1); }
    function removeFromHand(p,t,n){ let c=0; players[p]=players[p].filter(x=>{if(c<n&&isSame(x,t)){c++;return false}return true}); }
    function removeSpec(p,t){ let i=players[p].findIndex(x=>isSame(x,t)); if(i>-1)players[p].splice(i,1); }
    function tileSort(a,b){ const s={'chars':100,'dots':200,'bamboo':300,'honor':400}; return (s[a.type]+(typeof a.val==='string'?10:a.val)) - (s[b.type]+(typeof b.val==='string'?10:b.val)); }

    // INIT
    App.init();
    startGame();

</script>
</body>
</html>
